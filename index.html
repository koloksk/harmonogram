<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Harmonogram</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.css">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" type="image/png" href="./logo.png">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MUP">
  <meta name="theme-color" content="#0b1020">
  
  <!-- Service Worker - rejestracja od razu, bez czekania! -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('‚úÖ Service Worker zarejestrowany:', reg))
        .catch(err => console.error('‚ùå B≈ÇƒÖd rejestracji SW:', err));
    }
  </script>
  
  <!-- Zewnƒôtrzny plik CSS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Harmonogram</h1>
    <div style="display: flex; align-items: center; gap: 12px;">
      <div class="seg">
        <button id="viewMonth" aria-pressed="true" data-view="dayGridMonth">MiesiƒÖc</button>
        <button id="viewWeek" aria-pressed="false" data-view="timeGridWeek">Tydzie≈Ñ</button>
        <button id="viewDay" aria-pressed="false" data-view="timeGridDay">Dzie≈Ñ</button>
      </div>
      <button id="helpBtn" class="help-btn" title="ZarzƒÖdzaj harmonogramami" aria-label="ZarzƒÖdzaj harmonogramami">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      </button>
    </div>
  </header>

  <main>
    <aside>
      <!-- Kafelek nastƒôpujƒÖcych zajƒôƒá -->
      <div class="next-card" id="nextCard" aria-live="polite">
        <div class="next-header">
          <div class="next-status" id="nextStatus">Wyszukiwanie najbli≈ºszych zajƒôƒá‚Ä¶</div>
          <span class="next-badge" id="nextBadge" style="display:none">Zdalnie</span>
        </div>
        <div class="next-title" id="nextTitle">‚Äî</div>
        <div class="next-time"><span id="nextRange">‚Äî</span> <span class="next-room" id="nextRoom"></span></div>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Postƒôp zajƒôƒá">
          <div class="bar" id="nextProgress"></div>
        </div>
      </div>

      <div class="section-title">Filtry</div>
      <div class="filters">
        <div class="group">
          <label for="program">Kierunek studi√≥w</label>
          <select id="program"><option value="">Wszystkie</option></select>
        </div>
        <div class="group">
          <label for="type">Rodzaj zajƒôƒá</label>
          <select id="type"><option value="">Wszystkie</option></select>
        </div>
        <div class="group">
          <label for="room">Sala</label>
          <select id="room"><option value="">Wszystkie</option></select>
        </div>
        <div class="group">
          <label for="lecturer">Wyk≈Çadowca</label>
          <select id="lecturer"><option value="">Wszyscy</option></select>
        </div>
        <button id="reset" class="reset">Wyczy≈õƒá filtry</button>
      </div>

      <!-- Mapa kampusu -->
      <div class="campus-map">
        <div class="campus-map-title">Mapa Kampusu</div>
        <div class="map-container">
          <svg class="map-svg" viewBox="0 0 896 1152" xmlns="http://www.w3.org/2000/svg">
            <!-- T≈Ço - zdjƒôcie kampusu -->
            <image class="map-bg" href="./campus-map.png" x="0" y="0" width="896" height="1152" preserveAspectRatio="xMidYMid slice"/>
            
            <!-- CsH - Collegium sub Horologio (g√≥rny budynek w kszta≈Çcie T) -->
            <polygon 
              class="building-area" 
              data-building="csh" 
              data-name="Collegium sub Horologio"
              points="471,154 372,186 342,118 346,89 270,108 314,205 215,245 235,306 453,215 490,216">
              <title>Collegium sub Horologio (CsH)</title>
            </polygon>
            
            <!-- CP - Collegium Primum (≈õrodkowy budynek) -->
            <polygon 
              class="building-area" 
              data-building="cp" 
              data-name="Collegium Primum"
              points="559,457 458,491 447,485 430,502 337,537 353,589 573,512">
              <title>Collegium Primum (CP)</title>
            </polygon>
            
            <!-- CI - Collegium Inventorum (dolny budynek) -->
            <polygon 
              class="building-area" 
              data-building="ci" 
              data-name="Collegium Inventorum"
              points="617,648 552,673 611,833 574,858 584,882 626,875 684,1031 749,1003">
              <title>Collegium Inventorum (CI)</title>
            </polygon>
          </svg>
          
          <!-- Etykiety budynk√≥w (tooltips) -->
          <div class="building-label" id="label-csh">Collegium sub Horologio (CsH)</div>
          <div class="building-label" id="label-cp">Collegium Primum (CP)</div>
          <div class="building-label" id="label-ci">Collegium Inventorum (CI)</div>
        </div>
      </div>

      <div class="stats">
        <div class="card"><h3>≈ÅƒÖcznie</h3><div class="value" id="statTotal">0</div></div>
        <div class="card"><h3>Widocznych</h3><div class="value" id="statVisible">0</div></div>
      </div>

      <div class="export">
        <button id="exportGoogle" class="gcal-btn" aria-label="Eksportuj do Google Kalendarza" title="Pobierz plik .ics z aktualnie przefiltrowanymi wydarzeniami">
          <span class="gcal-logo" aria-hidden="true">
            <!-- Prosty, w≈Çasny znak w kolorach Google -->
            <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path fill="#EA4335" d="M24 9.5c3.38 0 6.44 1.18 8.85 3.13l6.63-6.63C35.6 2.25 30.12 0 24 0 14.6 0 6.45 5.4 2.55 13.2l7.92 6.15C12.16 13.5 17.61 9.5 24 9.5z"/>
              <path fill="#4285F4" d="M46.5 24.5c0-1.55-.15-3.05-.44-4.5H24v9h12.7c-.55 2.95-2.19 5.45-4.66 7.13l7.15 5.57C43.93 37.5 46.5 31.42 46.5 24.5z"/>
              <path fill="#FBBC05" d="M10.47 19.35l-7.92-6.15C.9 16.16 0 20.01 0 24c0 3.9.86 7.61 2.4 10.9l8.07-6.22C9.7 26.9 9.3 25.49 9.3 24c0-1.63.43-3.16 1.17-4.65z"/>
              <path fill="#34A853" d="M24 48c6.06 0 11.16-2 14.9-5.4l-7.15-5.57c-2.04 1.38-4.66 2.2-7.75 2.2-6.4 0-11.86-4.03-13.87-9.61l-8.07 6.22C6.88 43.07 14.7 48 24 48z"/>
            </svg>
          </span>
          <span>Importuj do Google Kalendarza</span>
        </button>
        <div class="export-hint">Pobierze plik .ics z obecnie przefiltrowanymi wydarzeniami. Nastƒôpnie zaimportuj go w Google Kalendarzu.</div>
      </div>
    </aside>
    <section id="calendar"></section>
  </main>

  <div id="tooltip" class="tooltip" style="display:none; opacity: 0;"></div>

  <!-- Modal zarzƒÖdzania harmonogramami -->
  <div id="scheduleModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          ZarzƒÖdzaj harmonogramami
        </h2>
        <button class="modal-close" id="modalClose" aria-label="Zamknij">&times;</button>
      </div>
      <div class="modal-body">
        <div id="scheduleListContainer"></div>
        
        <div class="add-schedule-section">
          <h3 class="add-schedule-title">Dodaj nowy harmonogram</h3>
          
          <!-- Dodaj z pliku -->
          <div class="file-input-wrapper">
            <label for="fileInput" class="file-input-label" id="fileInputLabel">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span id="fileInputText">Wybierz plik JSON lub XLSX</span>
            </label>
            <input type="file" id="fileInput" class="file-input" accept=".json,.xlsx,.xlsm" />
          </div>
          
          <!-- Separator LUB -->
          <div style="text-align: center; margin: 20px 0; color: rgba(255,255,255,0.5); font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">
            lub
          </div>
          
          <!-- Dodaj z URL -->
          <div class="url-input-wrapper">
            <div style="margin-bottom: 10px;">
              <label for="urlInput" style="display: block; font-size: 13px; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;">
                  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                </svg>
                Dodaj z URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input 
                  type="text" 
                  id="urlInput" 
                  placeholder="https://uczelnia.edu.pl/harmonogram.xlsx"
                  style="flex: 1; padding: 10px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 13px; font-family: 'Inter', sans-serif;"
                />
                <button 
                  id="addUrlBtn" 
                  style="padding: 10px 20px; background: linear-gradient(135deg, var(--accent) 0%, #667eea 100%); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 13px; transition: transform 0.2s, box-shadow 0.2s;"
                  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(118, 75, 235, 0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                >
                  Dodaj
                </button>
              </div>
            </div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 6px;">
              üí° Wspierane formaty: .xlsx, .xlsm, .json
            </div>
          </div>
        </div>

        <!-- O aplikacji -->
        <div class="about-section">
          <h3 class="about-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            O aplikacji
          </h3>
          <div class="about-content">
            <div class="about-item">
              <div class="about-label">Wersja</div>
              <div class="about-value">1.0.0</div>
            </div>
            <div class="about-item">
              <div class="about-label">Autor</div>
              <div class="about-value">koloksk</div>
            </div>
            <div class="about-item">
              <div class="about-label">Technologie</div>
              <div class="about-value">HTML ‚Ä¢ CSS ‚Ä¢ JavaScript ‚Ä¢ FullCalendar</div>
            </div>
            <div class="about-links">
              <a href="https://github.com/koloksk/harmonogram" target="_blank" rel="noopener noreferrer" class="about-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <span>Kod ≈∫r√≥d≈Çowy</span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </a>
              <a href="https://github.com/koloksk/harmonogram/issues" target="_blank" rel="noopener noreferrer" class="about-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>Zg≈Ço≈õ problem</span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.15/index.global.min.js"></script>
  <!-- ExcelJS - lepsza biblioteka do odczytu styl√≥w XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script>
    // ZMIANA: Przeniesienie element√≥w DOM na g√≥rƒô dla lepszej organizacji
    const calendarEl = document.getElementById('calendar');
    const filterElements = {
      program: document.getElementById('program'),
      type: document.getElementById('type'),
      room: document.getElementById('room'),
      lecturer: document.getElementById('lecturer'),
    };
    const statElements = {
      total: document.getElementById('statTotal'),
      visible: document.getElementById('statVisible'),
    };
    const viewButtons = document.querySelectorAll('.seg button');
    const tooltip = document.getElementById('tooltip');
    
    const STORAGE_KEY = 'harm_filters_v1';
    const SCHEDULES_STORAGE_KEY = 'harm_schedules_v1';
    const ACTIVE_SCHEDULE_KEY = 'harm_active_schedule_v1';
    
    let rawData = { events: [] };
    let fc;
    let schedules = [];
    let activeScheduleId = null;

    // ===== PARSOWANIE XLSX =====
    
    const MONTH_VARIANTS = {
      '01': ['stycznia'],
      '02': ['lutego'],
      '03': ['marca'],
      '04': ['kwietnia'],
      '05': ['maja'],
      '06': ['czerwca'],
      '07': ['lipca'],
      '08': ['sierpnia'],
      '09': ['wrzesnia', 'wrze≈õnia', 'wrze?nia'],
      '10': ['pa≈∫dziernika', 'pazdziernika', 'pa?dziernika'],
      '11': ['listopada'],
      '12': ['grudnia']
    };

    function parsePolishDateCell(cell){
      if(!cell) return null;
      const s = String(cell).toLowerCase();
      
      const yearMatch = s.match(/(20\d{2})/);
      if(!yearMatch) return null;
      const year = parseInt(yearMatch[1]);
      
      const dayMatch = s.match(/\b(\d{1,2})\b/);
      if(!dayMatch) return null;
      const day = parseInt(dayMatch[1]);
      
      let monthNum = null;
      for(const [mNum, variants] of Object.entries(MONTH_VARIANTS)){
        for(const v of variants){
          if(s.includes(v)){
            monthNum = mNum;
            break;
          }
        }
        if(monthNum) break;
      }
      
      if(!monthNum){
        const parts = s.match(/[a-zƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º\?]+/gi) || [];
        if(parts.length >= 2){
          const mid = parts[1].replace(/\?/g, 'z');
          for(const [mNum, variants] of Object.entries(MONTH_VARIANTS)){
            if(variants.some(v => mid === v)){
              monthNum = mNum;
              break;
            }
          }
        }
      }
      
      if(!monthNum) return null;
      
      try{
        // POPRAWKA: u≈ºywamy UTC aby uniknƒÖƒá przesuniƒôcia czasowego
        const dt = new Date(Date.UTC(year, parseInt(monthNum) - 1, day));
        return dt.toISOString().split('T')[0];
      }catch(e){
        return null;
      }
    }

    function addMinutes(hhmm, minutes){
      const [h, m] = hhmm.split(':').map(Number);
      const dt = new Date(2000, 0, 1, h, m);
      dt.setMinutes(dt.getMinutes() + minutes);
      return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
    }

    const TYPE_KEYWORDS = [
      ['LAB', 'LAB'],
      [' PROJEKT', 'PROJEKT'],
      ['PROJEKT', 'PROJEKT'],
      ['wyk≈Çad', 'W'],
      ['konwersatorium', 'K'],
      ['ƒáw', 'ƒÜW'],
      [' ƒÜW', 'ƒÜW'],
      [' ?W', 'ƒÜW'],
      [' ?w', 'ƒÜW'],
      // Uwaga: ' W' musi byƒá sprawdzane ostro≈ºnie, ≈ºeby nie wyciƒÖƒá "w" ze s≈Ç√≥w
      // Sprawdzamy tylko gdy jest spacjƒÖ przed i po, lub na ko≈Ñcu
      [' W ', 'W'],
      [' W\n', 'W'],
      ['\nW ', 'W'],
      [' K ', 'K'],
      [' K\n', 'K'],
    ];

    function parseCellDetails(text){
      const s = String(text || '').trim();
      const base = {
        title: null,
        type: null,
        lecturers: [],
        location: null,
        isRemote: false,
        color: null,
        raw: s
      };
      
      if(!s) return base;
      
      const sUp = ' ' + s.toUpperCase();
      for(const [key, val] of TYPE_KEYWORDS){
        if(sUp.includes(key.toUpperCase())){
          base.type = val;
          break;
        }
      }
      
      const lecturerPattern = /\b(?:dr hab\.|dr|mgr|prof\.?)(?: [a-zA-ZƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈ºƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª\.]+){1,3}/g;
      const lecturers = s.match(lecturerPattern) || [];
      if(lecturers.length) base.lecturers = lecturers;
      
      const roomPatterns = [
        /\b\d+\.\d+\s*(?:CP|CI|CsH)\b/i,
        /\b(?:CP|CI|CsH)\s*\d+\b/i,
        /\baula[^;\n]*/i,
        /\bsala[^;\n]*/i
      ];
      
      for(const pat of roomPatterns){
        const m = s.match(pat);
        if(m){
          base.location = m[0].trim();
          break;
        }
      }
      
      let t = s;
      t = t.replace(/\b\d+\s*\/\s*\d+\b/g, ' ');
      for(const lec of lecturers) t = t.replace(lec, ' ');
      if(base.location) t = t.replace(base.location, ' ');
      
      // POPRAWKA: Usu≈Ñ typy zajƒôƒá tylko jako osobne s≈Çowa, nie fragmenty innych s≈Ç√≥w
      // U≈ºywamy granic s≈Ç√≥w (\b) aby nie usuwaƒá "w" ze ≈õrodka s≈Ç√≥w
      t = t.replace(/\bLAB\b/gi, ' ');
      t = t.replace(/\bPROJEKT\b/gi, ' ');
      t = t.replace(/\bƒÜW\b/gi, ' ');
      t = t.replace(/\bƒÜw\b/gi, ' ');
      t = t.replace(/\b[ƒáƒÜ]w\b/gi, ' ');
      t = t.replace(/\bK\b(?!\w)/g, ' '); // K tylko je≈õli nie jest czƒô≈õciƒÖ s≈Çowa
      t = t.replace(/\bwyk≈Çad\b/gi, ' ');
      t = t.replace(/\bkonwersatorium\b/gi, ' ');
      // NIE usuwamy samego " W " - to mo≈ºe byƒá czƒô≈õƒá zdania!
      // Zamiast tego sprawdzamy tylko gdy W jest na ko≈Ñcu lub poczƒÖtku
      t = t.replace(/^\s*W\s+/i, ' '); // W na poczƒÖtku
      t = t.replace(/\s+W\s*$/i, ' '); // W na ko≈Ñcu
      t = t.replace(/\s+W\s+(?=[A-ZƒÑƒÜƒò≈Å≈É√ì≈ö≈π≈ª])/g, ' '); // W przed wielkƒÖ literƒÖ (np. "Algorytmy W Informatyka")
      
      t = t.replace(/\s+/g, ' ').replace(/^[ ;,\n\t]+|[ ;,\n\t]+$/g, '');
      
      if(t) base.title = t;
      
      return base;
    }

    function isCellTextRed(cell){
      if(!cell) return false;
      
      // Metoda 1: Sprawd≈∫ kolor czcionki w ExcelJS
      const font = cell.font;
      if(font && font.color){
        const color = font.color;
        
        // ExcelJS przechowuje kolor jako:
        // { argb: 'FFFF0000' } lub { theme: 2, tint: 0.5 } lub { indexed: 64 }
        
        // 1. Sprawd≈∫ ARGB (najczƒôstszy format)
        if(color.argb){
          const argb = String(color.argb).toUpperCase();
          // ARGB format: AA RR GG BB
          // Czerwony to: FFFF0000 (lub warianty)
          // Sprawdzamy ostatnie 6 znak√≥w (RRGGBB)
          const rgb = argb.length >= 6 ? argb.slice(-6) : argb;
          
          if(rgb === 'FF0000' || // czysty czerwony
             argb === 'FFFF0000' || // pe≈Çny ARGB czerwony
             rgb.startsWith('FF00') || // czerwony z odcieniem
             rgb.startsWith('F00') || // czerwony skr√≥cony
             rgb.startsWith('E00') || // ciemny czerwony
             rgb.startsWith('C00')){ // czerwony z odcieniem
            console.log('üî¥ WYKRYTO CZERWONY!', { cell: cell.address, argb, rgb });
            return true;
          }
        }
        
        // 2. Sprawd≈∫ indexed color (starsza metoda Excel)
        if(color.indexed !== undefined){
          // W Excel indexed 10 to czerwony
          const redIndexes = [2, 3, 10];
          if(redIndexes.includes(color.indexed)){
            console.log('üî¥ WYKRYTO CZERWONY (indexed)!', { cell: cell.address, indexed: color.indexed });
            return true;
          }
        }
        
        // 3. Sprawd≈∫ theme color
        if(color.theme !== undefined){
          // Theme 2 = Accent1 (czƒôsto czerwony w tematach)
          if(color.theme === 2 || color.theme === 6){
            console.log('üî¥ WYKRYTO CZERWONY (theme)!', { cell: cell.address, theme: color.theme });
            return true;
          }
        }
      }
      
      // Metoda 2: Sprawd≈∫ czy w tek≈õcie jest marker "zdalnie" (backup)
      let text = '';
      if(cell.value){
        if(cell.value.richText){
          text = cell.value.richText.map(t => t.text).join('');
        } else {
          text = String(cell.value);
        }
        
        text = text.toLowerCase();
        if(text.includes('zdalnie') || text.includes('online') || text.includes('teams')){
          console.log('üî¥ WYKRYTO ZDALNIE (tekst)!', { cell: cell.address, text: text.substring(0, 50) });
          return true;
        }
      }
      
      return false;
    }

    async function parseXLSXToEvents(arrayBuffer, fileName){
      try{
        console.log('üìä Parsowanie XLSX z ExcelJS:', fileName);
        
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(arrayBuffer);
        
        const worksheet = workbook.worksheets[0];
        const sheetName = worksheet.name;
        
        console.log('üìÑ Arkusz:', sheetName);
        
        const maxCol = worksheet.columnCount;
        const maxRow = worksheet.rowCount;
        
        console.log('üìè Wymiary:', `${maxRow} wierszy x ${maxCol} kolumn`);
        
        // Forward-fill nag≈Ç√≥wk√≥w z wierszy 1-4 (wiersz 5 to podgrupy, pomijamy!)
        const headers = {};
        let lastZjazd = null, lastDateRaw = null, lastDay = null, lastProgram = null;
        
        function getCellValue(row, col){
          // ExcelJS: row i col sƒÖ 1-indexed
          const cell = worksheet.getRow(row).getCell(col);
          return cell ? cell.value : null;
        }
        
        function getCell(row, col){
          // ExcelJS: row i col sƒÖ 1-indexed
          return worksheet.getRow(row).getCell(col);
        }
        
        function toDateISO(val){
          if(!val) return null;
          if(val instanceof Date){
            // POPRAWKA: u≈ºywamy UTC aby uniknƒÖƒá przesuniƒôcia czasowego
            const year = val.getUTCFullYear();
            const month = String(val.getUTCMonth() + 1).padStart(2, '0');
            const day = String(val.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          }
          if(typeof val === 'number'){
            // ExcelJS zwraca daty jako obiekt Date lub numer
            // Je≈õli to numer seryjny Excela, konwertujemy
            const excelEpoch = new Date(Date.UTC(1899, 11, 30));
            const d = new Date(excelEpoch.getTime() + val * 86400000);
            const year = d.getUTCFullYear();
            const month = String(d.getUTCMonth() + 1).padStart(2, '0');
            const day = String(d.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          }
          // ExcelJS mo≈ºe zwr√≥ciƒá obiekt { richText: [...] }
          if(val && val.richText){
            const text = val.richText.map(t => t.text).join('');
            return parsePolishDateCell(text);
          }
          return parsePolishDateCell(String(val));
        }
        
        // UWAGA: ExcelJS u≈ºywa 1-indexed (wiersz 1, kolumna 1)
        // Wiersze 1-4: ZJAZD, DATA, DZIE≈É, PROGRAM/KIERUNEK
        // Wiersz 5: PODGRUPY (pomijamy!)
        // Od wiersza 6: dane zajƒôƒá
        for(let c = 1; c <= maxCol; c++){
          const zjazd = getCellValue(1, c); // wiersz 1: ZJAZD
          const dateV = getCellValue(2, c); // wiersz 2: DATA
          const dayV = getCellValue(3, c);  // wiersz 3: DZIE≈É TYGODNIA
          const programV = getCellValue(4, c); // wiersz 4: PROGRAM/KIERUNEK
          // Wiersz 5 = podgrupy, pomijamy!
          
          // POPRAWKA: Nie u≈ºywaj forward-fill dla zjazdu je≈õli warto≈õƒá to "nr" lub "zjazd"
          if(zjazd && String(zjazd).trim()){
            const zjazdStr = String(zjazd).trim().toLowerCase();
            if(zjazdStr !== 'nr' && zjazdStr !== 'zjazd' && zjazdStr !== 'lp' && zjazdStr !== 'lp.'){
              lastZjazd = String(zjazd).trim();
            }
          }
          if(dateV) lastDateRaw = dateV;
          if(dayV && String(dayV).trim()) lastDay = String(dayV).trim();
          if(programV && String(programV).trim()) lastProgram = String(programV).trim();
          
          headers[c] = {
            zjazd: lastZjazd,
            date: toDateISO(lastDateRaw),
            day: lastDay,
            program: lastProgram
          };
        }
        
        // Mapa scale≈Ñ - ExcelJS Model
        const mergedMap = {};
        // ExcelJS przechowuje merged cells w worksheet.model.merges
        const merges = worksheet.model?.merges || [];
        for(const mergeAddr of merges){
          // mergeAddr jest stringiem jak "A1:B2"
          const [start, end] = mergeAddr.split(':');
          const startCell = worksheet.getCell(start);
          const endCell = worksheet.getCell(end);
          
          const minR = startCell.row;
          const minC = startCell.col;
          const maxR = endCell.row;
          const maxC = endCell.col;
          
          for(let rr = minR; rr <= maxR; rr++){
            for(let cc = minC; cc <= maxC; cc++){
              mergedMap[`${rr},${cc}`] = {minR, minC, maxR, maxC};
            }
          }
        }
        
        function timeFromRow(rr){
          // ExcelJS: wiersz 1-5 to nag≈Ç√≥wki/podgrupy, dane od wiersza 6
          if(rr < 6) return null;
          const idx = rr - 6; // Wiersz 6 = index 0 (godzina 08:00)
          const h = 8 + Math.floor((idx * 15) / 60);
          const m = (idx * 15) % 60;
          return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }
        
        const events = [];
        
        for(let c = 1; c <= maxCol; c++){
          const meta = headers[c] || {};
          const dateISO = meta.date;
          const dayName = meta.day;
          const program = meta.program;
          const zjazd = meta.zjazd;
          
          // Debug: loguj problematyczne kolumny
          if(dateISO && dateISO.includes('2025-11-21') && program === 'ENER'){
            console.log(`üîç Kolumna ${c} dla ENER 21.11.2025:`, {
              zjazd, date: dateISO, day: dayName, program
            });
          }
          
          // POPRAWKA: Bardziej rygorystyczna walidacja kolumny
          // Pomijamy kolumny bez daty, programu lub ze zjadem "nr" (to nag≈Ç√≥wki!)
          if(!dateISO || !program || !zjazd) continue;
          
          const zjazdLower = String(zjazd).toLowerCase().trim();
          if(zjazdLower === 'nr' || zjazdLower === 'zjazd' || zjazdLower === 'lp' || zjazdLower === 'lp.') continue;
          
          // Dodatkowa walidacja - zjazd powinien zawieraƒá cyfrƒô lub byƒá liczbƒÖ
          if(!/\d/.test(String(zjazd))) {
            console.warn(`‚ö†Ô∏è Pominiƒôto kolumnƒô ${c} - zjazd nie zawiera cyfry: "${zjazd}"`);
            continue;
          }
          
          // Dodatkowa walidacja - sprawd≈∫ czy data jest sensowna (po 2020 roku)
          const yearMatch = dateISO.match(/^(\d{4})/);
          if(yearMatch && parseInt(yearMatch[1]) < 2020) continue;
          
          let r = 6; // PoczƒÖtek danych (wiersz 6 w ExcelJS, wiersz 5 to podgrupy)
          while(r <= Math.min(maxRow, 57)){ // Max wiersz 57
            const mergeKey = `${r},${c}`;
            const tl = mergedMap[mergeKey];
            let height = 1;
            let topLeftR = r, topLeftC = c;
            
            if(tl){
              if(r !== tl.minR || c !== tl.minC){
                r++;
                continue;
              }
              height = tl.maxR - tl.minR + 1;
              topLeftR = tl.minR;
              topLeftC = tl.minC;
            }
            
            const cellObj = getCell(topLeftR, topLeftC);
            const cellVal = cellObj ? cellObj.value : null;
            let text = '';
            
            // ExcelJS mo≈ºe zwr√≥ciƒá richText
            if(cellVal && cellVal.richText){
              text = cellVal.richText.map(t => t.text).join('').trim();
            } else {
              text = String(cellVal || '').trim();
            }
            
            if(text){
              const details = parseCellDetails(text);
              
              // POPRAWKA: Pomi≈Ñ wydarzenia kt√≥re nie majƒÖ tytu≈Çu lub tytu≈Ç to tylko cyfry/spacje
              if(!details.title || !details.title.trim()) {
                console.warn(`‚ö†Ô∏è Pominiƒôto kom√≥rkƒô [${topLeftR},${topLeftC}] - brak tytu≈Çu po parsowaniu: "${text.substring(0, 50)}"`);
                r++;
                continue;
              }
              
              // Pomi≈Ñ je≈õli tytu≈Ç to tylko cyfry (np. "08:00" po usuniƒôciu dwukropka, albo numer pokoju "123")
              const titleOnlyDigits = /^[\d\s:.\-/]+$/.test(details.title.trim());
              if(titleOnlyDigits) {
                console.warn(`‚ö†Ô∏è Pominiƒôto kom√≥rkƒô [${topLeftR},${topLeftC}] - tytu≈Ç zawiera tylko cyfry: "${details.title}"`);
                r++;
                continue;
              }
              
              const startTime = timeFromRow(r);
              const endTime = startTime ? addMinutes(startTime, height * 15) : null;
              const remote = isCellTextRed(cellObj);
              
              // Debug: loguj WSZYSTKIE kom√≥rki ze stylami (pierwsze 5)
              if(events.length < 5 && cellObj && cellObj.font){
                console.log(`üìù Kom√≥rka [${topLeftR},${topLeftC}]:`, {
                  text: text.substring(0, 50),
                  hasFont: !!cellObj.font,
                  font: cellObj.font,
                  color: cellObj.font?.color,
                  isRed: remote
                });
              }
              
              // Debug: loguj zdalne zajƒôcia
              if(remote){
                console.log('üî¥ Znaleziono zajƒôcia zdalne:', {
                  title: details.title,
                  date: dateISO,
                  time: startTime,
                  cell: `[${topLeftR},${topLeftC}]`
                });
              }
              
              events.push({
                zjazd: zjazd,
                program: program,
                date: dateISO,
                day: dayName,
                startTime: startTime,
                endTime: endTime,
                title: details.title,
                type: details.type,
                lecturers: details.lecturers,
                location: details.location,
                isRemote: remote,
                color: remote ? 'red' : null,
                raw: details.raw
              });
              
              r += height;
            } else {
              r++;
            }
          }
        }
        
        events.sort((a, b) => {
          const dateA = a.date || '';
          const dateB = b.date || '';
          if(dateA !== dateB) return dateA.localeCompare(dateB);
          
          const progA = a.program || '';
          const progB = b.program || '';
          if(progA !== progB) return progA.localeCompare(progB);
          
          const timeA = a.startTime || '';
          const timeB = b.startTime || '';
          return timeA.localeCompare(timeB);
        });
        
        // Statystyki parsowania
        const remoteCount = events.filter(e => e.isRemote).length;
        console.log(`‚úÖ Sparsowano ${events.length} wydarze≈Ñ (${remoteCount} zdalnych - ${(remoteCount/events.length*100).toFixed(1)}%)`);
        
        if(remoteCount === 0){
          console.warn('‚ö†Ô∏è Nie znaleziono ≈ºadnych zdalnych zajƒôƒá!');
          console.log('üí° Wskaz√≥wka: Sprawd≈∫ czy w Excelu czerwony kolor jest ustawiony jako kolor czcionki (nie t≈Ça)');
          console.log('üí° Alternatywa: Dodaj s≈Çowo "zdalnie" w tek≈õcie zajƒôƒá');
        }
        
        return {
          source_file: fileName,
          generated_at: new Date().toISOString(),
          program: 'ALL',
          events: events
        };
      }catch(err){
        console.error('B≈ÇƒÖd parsowania XLSX:', err);
        throw new Error('Nie uda≈Ço siƒô przetworzyƒá pliku XLSX: ' + err.message);
      }
    }
    
    // ===== KONIEC PARSOWANIA XLSX =====

    // ===== SYSTEM ZARZƒÑDZANIA HARMONOGRAMAMI =====
    
    // Funkcja do pobierania aktualnego linku harmonogramu ze strony uczelni
    async function fetchScheduleUrlFromUniversity(){
      try {
        const pageUrl = 'http://uczelniaoswiecim.edu.pl/instytuty/new-instytut-nauk-inzynieryjno-technicznych/harmonogramy/';
        
        // U≈ºyj CORS proxy do pobrania strony
        const corsProxy = 'https://corsproxy.io/?';
        const proxiedUrl = corsProxy + encodeURIComponent(pageUrl);
        
        const response = await fetch(proxiedUrl, {
          cache: 'no-store'
        });
        
        if(!response.ok){
          throw new Error(`Nie uda≈Ço siƒô pobraƒá strony (status: ${response.status})`);
        }
        
        const html = await response.text();
        
        // Parsuj HTML i znajd≈∫ link z tekstem zawierajƒÖcym "Harmonogram na studia niestacjonarne"
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Szukaj linku z tekstem zawierajƒÖcym "niestacjonarne"
        const links = Array.from(doc.querySelectorAll('a'));
        const scheduleLink = links.find(link => {
          const text = link.textContent || '';
          const href = link.href || '';
          return text.toLowerCase().includes('niestacjonarne') && 
                 (href.toLowerCase().endsWith('.xlsx') || href.toLowerCase().endsWith('.xlsm'));
        });
        
        if(scheduleLink && scheduleLink.href){
          // Upewnij siƒô ≈ºe mamy pe≈Çny URL
          let url = scheduleLink.href;
          if(!url.startsWith('http')){
            url = new URL(url, pageUrl).href;
          }
          
          // Zamie≈Ñ HTTPS na HTTP (strona uczelni dzia≈Ça na HTTP)
          url = url.replace(/^https:\/\//i, 'http://');
          
          console.log('‚úÖ Znaleziono link do harmonogramu:', url);
          return url;
        }
        
        throw new Error('Nie znaleziono linku do harmonogramu niestacjonarnego na stronie');
      } catch(error) {
        console.error('‚ùå B≈ÇƒÖd pobierania linku harmonogramu:', error);
        // Fallback do ostatnio znanego URL
        return 'http://uczelniaoswiecim.edu.pl/wp-content/uploads/2022/10/Harmonogram-studia-niestacjonarne-aktualizacja-13.11.2025.xlsx';
      }
    }
    
    async function loadSchedulesFromStorage(){
      try{
        const stored = localStorage.getItem(SCHEDULES_STORAGE_KEY);
        schedules = stored ? JSON.parse(stored) : [];
        activeScheduleId = localStorage.getItem(ACTIVE_SCHEDULE_KEY) || null;
        
        // Dodaj domy≈õlny harmonogram je≈õli nie ma ≈ºadnych
        if(schedules.length === 0){
          // Pobierz aktualny link ze strony uczelni
          const scheduleUrl = await fetchScheduleUrlFromUniversity();
          
          schedules.push({
            id: 'default',
            name: 'Harmonogram studia niestacjonarne',
            path: scheduleUrl,
            isDefault: true,
            addedAt: new Date().toISOString(),
            status: 'unknown',
            eventsCount: 0,
            errors: [],
            autoUpdate: true // Flaga oznaczajƒÖca ≈ºe ten harmonogram powinien byƒá automatycznie aktualizowany
          });
          activeScheduleId = 'default';
          saveSchedulesToStorage();
        }
        
        // Sprawd≈∫ czy domy≈õlny harmonogram wymaga aktualizacji (raz dziennie)
        const defaultSchedule = schedules.find(s => s.id === 'default' && s.autoUpdate);
        if(defaultSchedule){
          const lastCheck = localStorage.getItem('harm_last_url_check');
          const now = Date.now();
          const oneDayMs = 24 * 60 * 60 * 1000;
          
          if(!lastCheck || (now - parseInt(lastCheck)) > oneDayMs){
            console.log('üîÑ Sprawdzanie aktualizacji URL harmonogramu...');
            const newUrl = await fetchScheduleUrlFromUniversity();
            
            if(newUrl !== defaultSchedule.path){
              console.log('‚úÖ Znaleziono nowy URL harmonogramu:', newUrl);
              defaultSchedule.path = newUrl;
              saveSchedulesToStorage();
            }
            
            localStorage.setItem('harm_last_url_check', now.toString());
          }
        }
      }catch(e){
        console.error('B≈ÇƒÖd wczytywania harmonogram√≥w', e);
        schedules = [];
      }
    }

    function saveSchedulesToStorage(){
      try{
        localStorage.setItem(SCHEDULES_STORAGE_KEY, JSON.stringify(schedules));
        if(activeScheduleId){
          localStorage.setItem(ACTIVE_SCHEDULE_KEY, activeScheduleId);
        }
      }catch(e){
        console.error('B≈ÇƒÖd zapisywania harmonogram√≥w', e);
      }
    }

    function getActiveSchedule(){
      return schedules.find(s => s.id === activeScheduleId) || schedules[0];
    }

    async function validateScheduleFile(data, scheduleName){
      const errors = [];
      const warnings = [];
      
      if(!data || typeof data !== 'object'){
        errors.push('Nieprawid≈Çowy format pliku JSON');
        return { valid: false, errors, warnings, eventsCount: 0 };
      }
      
      if(!Array.isArray(data.events)){
        errors.push('Brak tablicy "events" w pliku');
        return { valid: false, errors, warnings, eventsCount: 0 };
      }
      
      const eventsCount = data.events.length;
      
      if(eventsCount === 0){
        warnings.push('Plik nie zawiera ≈ºadnych wydarze≈Ñ');
      }
      
      // Walidacja struktury wydarze≈Ñ
      let invalidEvents = 0;
      data.events.forEach((e, idx) => {
        if(!e.date && !e.start){
          invalidEvents++;
        }
      });
      
      if(invalidEvents > 0){
        warnings.push(`${invalidEvents} wydarze≈Ñ nie ma daty`);
      }
      
      return {
        valid: errors.length === 0,
        errors,
        warnings,
        eventsCount
      };
    }

    async function addScheduleFromFile(file){
      const fileName = file.name.toLowerCase();
      const isXlsx = fileName.endsWith('.xlsx') || fileName.endsWith('.xlsm');
      
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try{
            let data;
            
            if(isXlsx){
              // Parsowanie pliku XLSX
              data = await parseXLSXToEvents(e.target.result, file.name);
            } else {
              // Parsowanie pliku JSON
              data = JSON.parse(e.target.result);
            }
            
            const validation = await validateScheduleFile(data, file.name);
            
            const newSchedule = {
              id: 'custom_' + Date.now(),
              name: file.name.replace(/\.(json|xlsx|xlsm)$/i, ''),
              path: null, // Custom file, stored in data
              data: data, // Store data directly
              isDefault: false,
              addedAt: new Date().toISOString(),
              status: validation.valid ? 'success' : (validation.errors.length > 0 ? 'error' : 'warning'),
              eventsCount: validation.eventsCount,
              errors: validation.errors,
              warnings: validation.warnings || []
            };
            
            schedules.push(newSchedule);
            saveSchedulesToStorage();
            renderScheduleList();
            resolve(newSchedule);
          }catch(err){
            reject(new Error('Nieprawid≈Çowy format pliku: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('B≈ÇƒÖd wczytywania pliku'));
        
        if(isXlsx){
          reader.readAsArrayBuffer(file);
        } else {
          reader.readAsText(file);
        }
      });
    }

    async function addScheduleFromURL(url, customName = null){
      try {
        // Walidacja URL
        if(!url || !url.trim()){
          throw new Error('Podaj adres URL');
        }
        
        url = url.trim();
        
        // Sprawd≈∫ czy to prawid≈Çowy URL
        let urlObj;
        try {
          urlObj = new URL(url);
        } catch(e) {
          throw new Error('Nieprawid≈Çowy format URL. Przyk≈Çad: https://uczelnia.edu.pl/harmonogram.xlsx');
        }
        
        // Sprawd≈∫ rozszerzenie
        const fileName = urlObj.pathname.split('/').pop() || 'harmonogram';
        const lowerFileName = fileName.toLowerCase();
        const isXlsx = lowerFileName.endsWith('.xlsx') || lowerFileName.endsWith('.xlsm');
        const isJson = lowerFileName.endsWith('.json');
        
        if(!isXlsx && !isJson){
          throw new Error('Nieobs≈Çugiwany format pliku. Wspierane: .xlsx, .xlsm, .json');
        }
        
        // Sprawd≈∫ czy ju≈º istnieje harmonogram z tym URL
        const existing = schedules.find(s => s.path === url);
        if(existing){
          throw new Error('Harmonogram z tym URL ju≈º istnieje');
        }
        
        // Poka≈º overlay z ≈Çadowaniem
        const loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loadingOverlay';
        loadingOverlay.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(11,16,32,0.95); padding: 20px 40px; border-radius: 12px; color: white; z-index: 10001; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.4);';
        loadingOverlay.innerHTML = '<div style="font-size: 16px; margin-bottom: 10px;">‚è≥ Pobieranie harmonogramu...</div><div style="font-size: 12px; opacity: 0.7;">' + url + '</div>';
        document.body.appendChild(loadingOverlay);
        
        // Pobierz plik
        let res;
        try {
          res = await fetch(url, { 
            cache: 'no-store',
            mode: 'cors'
          });
          
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
        } catch (corsError) {
          console.warn('‚ö†Ô∏è B≈ÇƒÖd CORS, pr√≥ba u≈ºycia CORS proxy...', corsError);
          
          // Fallback do CORS proxy
          const corsProxy = 'https://corsproxy.io/?';
          const proxiedUrl = corsProxy + encodeURIComponent(url);
          
          res = await fetch(proxiedUrl, { 
            cache: 'no-store'
          });
          
          if (!res.ok) {
            throw new Error(`Nie uda≈Ço siƒô pobraƒá pliku (status: ${res.status})`);
          }
        }
        
        // Parsuj dane
        let data;
        if(isXlsx){
          const arrayBuffer = await res.arrayBuffer();
          data = await parseXLSXToEvents(arrayBuffer, fileName);
        } else {
          data = await res.json();
        }
        
        // Waliduj
        const validation = await validateScheduleFile(data, fileName);
        
        // Utw√≥rz nowy harmonogram
        const newSchedule = {
          id: 'url_' + Date.now(),
          name: customName || fileName.replace(/\.(json|xlsx|xlsm)$/i, ''),
          path: url,
          isDefault: false,
          addedAt: new Date().toISOString(),
          status: validation.valid ? 'success' : (validation.errors.length > 0 ? 'error' : 'warning'),
          eventsCount: validation.eventsCount,
          errors: validation.errors,
          warnings: validation.warnings || []
        };
        
        schedules.push(newSchedule);
        saveSchedulesToStorage();
        
        // Usu≈Ñ overlay ≈Çadowania
        document.body.removeChild(loadingOverlay);
        
        // Aktywuj nowy harmonogram
        activeScheduleId = newSchedule.id;
        saveSchedulesToStorage();
        renderScheduleList();
        loadData();
        
        // Poka≈º sukces
        const successMsg = document.createElement('div');
        successMsg.id = 'successOverlay';
        successMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(11,16,32,0.95); padding: 20px 40px; border-radius: 12px; color: white; z-index: 10001; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.4);';
        successMsg.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
          <div style="font-size: 16px; margin-bottom: 8px; font-weight: bold;">Harmonogram dodany!</div>
          <div style="font-size: 13px; opacity: 0.7;">Pobrano ${validation.eventsCount} wydarze≈Ñ</div>
        `;
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
          successMsg.style.transition = 'opacity 0.3s';
          successMsg.style.opacity = '0';
          setTimeout(() => {
            if(document.body.contains(successMsg)){
              document.body.removeChild(successMsg);
            }
          }, 300);
        }, 2000);
        
        return newSchedule;
      } catch(error) {
        // Usu≈Ñ overlay ≈Çadowania je≈õli istnieje
        const loadingOverlay = document.getElementById('loadingOverlay');
        if(loadingOverlay){
          document.body.removeChild(loadingOverlay);
        }
        
        throw error;
      }
    }

    function deleteSchedule(scheduleId){
      if(schedules.find(s => s.id === scheduleId)?.isDefault){
        alert('Nie mo≈ºna usunƒÖƒá domy≈õlnego harmonogramu');
        return;
      }
      
      schedules = schedules.filter(s => s.id !== scheduleId);
      
      // Je≈õli usuwamy aktywny harmonogram, aktywuj inny
      if(activeScheduleId === scheduleId){
        activeScheduleId = schedules[0]?.id || null;
        saveSchedulesToStorage();
        renderScheduleList(); // Najpierw od≈õwie≈º listƒô
        if(activeScheduleId){
          loadData(); // Potem za≈Çaduj nowe dane
        } else {
          // Brak harmonogram√≥w - wyczy≈õƒá kalendarz
          if(fc) fc.removeAllEvents();
          rawData = { events: [] };
          statElements.total.textContent = '0';
          statElements.visible.textContent = '0';
        }
      } else {
        saveSchedulesToStorage();
        renderScheduleList();
      }
    }

    function switchSchedule(scheduleId){
      activeScheduleId = scheduleId;
      saveSchedulesToStorage();
      loadData(); // Reload calendar with new schedule
      renderScheduleList();
    }

    function renderScheduleList(){
      const container = document.getElementById('scheduleListContainer');
      
      if(schedules.length === 0){
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <h3>Brak harmonogram√≥w</h3>
            <p>Dodaj sw√≥j pierwszy harmonogram poni≈ºej</p>
          </div>
        `;
        return;
      }
      
      const html = `
        <div class="schedule-list">
          ${schedules.map(schedule => {
            const isActive = schedule.id === activeScheduleId;
            const statusClass = schedule.status === 'success' ? 'success' : 
                               schedule.status === 'error' ? 'error' : 'warning';
            const statusText = schedule.status === 'success' ? 'OK' : 
                              schedule.status === 'error' ? 'B≈ÇƒÖd' : 'Ostrze≈ºenie';
            
            return `
              <div class="schedule-item ${isActive ? 'active' : ''}" data-schedule-id="${schedule.id}">
                <div class="schedule-header">
                  <div>
                    <h3 class="schedule-name">
                      ${escapeHtml(schedule.name)}
                      ${isActive ? ' <span style="color: var(--accent); font-size: 12px;">‚óè Aktywny</span>' : ''}
                    </h3>
                    ${schedule.path ? `<div class="schedule-path">${escapeHtml(schedule.path)}</div>` : '<div class="schedule-path">Plik w≈Çasny</div>'}
                  </div>
                  <div class="schedule-status ${statusClass}">
                    <span class="status-dot"></span>
                    ${statusText}
                  </div>
                </div>
                
                <div class="schedule-meta">
                  <div class="schedule-meta-item">
                    <span>üìä Wydarzenia:</span>
                    <strong>${schedule.eventsCount}</strong>
                  </div>
                  <div class="schedule-meta-item">
                    <span>üìÖ Dodano:</span>
                    <strong>${new Date(schedule.addedAt).toLocaleDateString('pl-PL')}</strong>
                  </div>
                  ${schedule.errors && schedule.errors.length > 0 ? `
                    <div class="schedule-meta-item" style="color: var(--danger);">
                      <span>‚ö†Ô∏è B≈Çƒôdy:</span>
                      <strong>${schedule.errors.length}</strong>
                    </div>
                  ` : ''}
                  ${schedule.warnings && schedule.warnings.length > 0 ? `
                    <div class="schedule-meta-item" style="color: #fbbf24;">
                      <span>‚ö†Ô∏è Ostrze≈ºenia:</span>
                      <strong>${schedule.warnings.length}</strong>
                    </div>
                  ` : ''}
                </div>
                
                ${schedule.errors && schedule.errors.length > 0 ? `
                  <div style="margin-top: 10px; padding: 10px; background: rgba(255,90,90,0.1); border-radius: 8px; font-size: 12px; color: var(--danger);">
                    ${schedule.errors.map(e => `‚Ä¢ ${escapeHtml(e)}`).join('<br>')}
                  </div>
                ` : ''}
                
                ${schedule.warnings && schedule.warnings.length > 0 ? `
                  <div style="margin-top: 10px; padding: 10px; background: rgba(251,191,36,0.1); border-radius: 8px; font-size: 12px; color: #fbbf24;">
                    ${schedule.warnings.map(w => `‚Ä¢ ${escapeHtml(w)}`).join('<br>')}
                  </div>
                ` : ''}
                
                <div class="schedule-actions">
                  ${!isActive ? `<button class="schedule-btn primary" onclick="switchSchedule('${schedule.id}')">Aktywuj</button>` : ''}
                  ${schedule.autoUpdate ? `<button class="schedule-btn secondary" onclick="refreshScheduleUrl('${schedule.id}')" title="Sprawd≈∫ czy uczelnia opublikowa≈Ça nowy harmonogram">üîÑ Od≈õwie≈º URL</button>` : ''}
                  ${!schedule.isDefault ? `<button class="schedule-btn danger" onclick="confirmDeleteSchedule('${schedule.id}')">Usu≈Ñ</button>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }

    function confirmDeleteSchedule(scheduleId){
      const schedule = schedules.find(s => s.id === scheduleId);
      if(confirm(`Czy na pewno chcesz usunƒÖƒá harmonogram "${schedule.name}"?`)){
        deleteSchedule(scheduleId);
      }
    }

    async function refreshScheduleUrl(scheduleId){
      const schedule = schedules.find(s => s.id === scheduleId);
      if(!schedule || !schedule.autoUpdate){
        return;
      }
      
      // Poka≈º overlay z ≈Çadowaniem
      const loadingOverlay = document.createElement('div');
      loadingOverlay.id = 'refreshOverlay';
      loadingOverlay.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(11,16,32,0.95); padding: 20px 40px; border-radius: 12px; color: white; z-index: 10001; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.4);';
      loadingOverlay.innerHTML = '<div style="font-size: 16px; margin-bottom: 10px;">üîÑ Sprawdzanie strony uczelni...</div><div style="font-size: 12px; opacity: 0.7;">Szukam aktualnego linku do harmonogramu</div>';
      document.body.appendChild(loadingOverlay);
      
      try {
        const oldUrl = schedule.path;
        const newUrl = await fetchScheduleUrlFromUniversity();
        
        document.body.removeChild(loadingOverlay);
        
        if(newUrl !== oldUrl){
          // Znaleziono nowy URL
          schedule.path = newUrl;
          localStorage.setItem('harm_last_url_check', Date.now().toString());
          saveSchedulesToStorage();
          renderScheduleList();
          
          // Poka≈º komunikat o znalezieniu nowej wersji
          const successMsg = document.createElement('div');
          successMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(11,16,32,0.95); padding: 20px 40px; border-radius: 12px; color: white; z-index: 10001; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.4);';
          successMsg.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">üÜï</div>
            <div style="font-size: 16px; margin-bottom: 8px; font-weight: bold;">Znaleziono nowƒÖ wersjƒô!</div>
            <div style="font-size: 13px; opacity: 0.7; margin-bottom: 12px;">URL harmonogramu zosta≈Ç zaktualizowany</div>
            <button onclick="this.parentElement.remove(); loadData();" style="padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Za≈Çaduj nowƒÖ wersjƒô</button>
          `;
          document.body.appendChild(successMsg);
        } else {
          // Brak zmian
          const infoMsg = document.createElement('div');
          infoMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(11,16,32,0.95); padding: 20px 40px; border-radius: 12px; color: white; z-index: 10001; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.4);';
          infoMsg.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
            <div style="font-size: 16px; margin-bottom: 8px; font-weight: bold;">Masz aktualnƒÖ wersjƒô</div>
            <div style="font-size: 13px; opacity: 0.7;">Harmonogram nie zmieni≈Ç siƒô</div>
          `;
          document.body.appendChild(infoMsg);
          
          localStorage.setItem('harm_last_url_check', Date.now().toString());
          
          setTimeout(() => {
            infoMsg.style.transition = 'opacity 0.3s';
            infoMsg.style.opacity = '0';
            setTimeout(() => {
              if(document.body.contains(infoMsg)){
                document.body.removeChild(infoMsg);
              }
            }, 300);
          }, 2000);
        }
      } catch(error) {
        if(document.body.contains(loadingOverlay)){
          document.body.removeChild(loadingOverlay);
        }
        
        console.error('B≈ÇƒÖd od≈õwie≈ºania URL:', error);
        alert('‚ùå Nie uda≈Ço siƒô sprawdziƒá strony uczelni: ' + error.message);
      }
    }

    // Modal controls
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('scheduleModal');
      const helpBtn = document.getElementById('helpBtn');
      const modalClose = document.getElementById('modalClose');
      const fileInput = document.getElementById('fileInput');
      
      helpBtn.addEventListener('click', () => {
        modal.classList.add('active');
        renderScheduleList();
        // Reset tekstu przycisku przy otwieraniu modala
        const fileInputText = document.getElementById('fileInputText');
        if(fileInputText) fileInputText.textContent = 'Wybierz plik JSON lub XLSX';
        fileInput.value = ''; // Wyczy≈õƒá input pliku
        
        // Wyczy≈õƒá pole URL
        const urlInput = document.getElementById('urlInput');
        if(urlInput) {
          urlInput.value = '';
          urlInput.style.borderColor = 'rgba(255,255,255,0.1)';
        }
      });
      
      modalClose.addEventListener('click', () => {
        modal.classList.remove('active');
      });
      
      modal.addEventListener('click', (e) => {
        if(e.target === modal){
          modal.classList.remove('active');
        }
      });
      
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const fileInputText = document.getElementById('fileInputText');
        
        if(!file){
          // Reset label je≈õli anulowano wyb√≥r
          if(fileInputText) fileInputText.textContent = 'Wybierz plik JSON lub XLSX';
          return;
        }
        
        console.log('üìÅ Wybrano plik:', file.name, 'Typ:', file.type, 'Rozmiar:', file.size);
        
        // Poka≈º nazwƒô wybranego pliku
        if(fileInputText) fileInputText.textContent = `üìÑ ${file.name}`;
        
        const fileName = file.name.toLowerCase();
        const validExtensions = ['.json', '.xlsx', '.xlsm'];
        const isValid = validExtensions.some(ext => fileName.endsWith(ext));
        
        if(!isValid){
          alert('‚ùå Nieprawid≈Çowy typ pliku. Obs≈Çugiwane formaty: JSON, XLSX, XLSM');
          fileInput.value = '';
          if(fileInputText) fileInputText.textContent = 'Wybierz plik JSON lub XLSX';
          return;
        }
        
        let processing = null;
        
        try{
          // Pokazanie informacji o przetwarzaniu dla plik√≥w XLSX (mo≈ºe trwaƒá d≈Çu≈ºej)
          if(fileName.endsWith('.xlsx') || fileName.endsWith('.xlsm')){
            processing = document.createElement('div');
            processing.id = 'processingOverlay';
            processing.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(11,16,32,0.95); padding: 20px 40px; border-radius: 12px; color: white; z-index: 10001; text-align: center;';
            processing.innerHTML = '<div style="font-size: 16px; margin-bottom: 10px;">‚è≥ Przetwarzanie pliku XLSX...</div><div style="font-size: 12px; opacity: 0.7;">To mo≈ºe chwilƒô potrwaƒá</div>';
            document.body.appendChild(processing);
            
            await new Promise(resolve => setTimeout(resolve, 100)); // Daj czas na pokazanie komunikatu
          }
          
          const newSchedule = await addScheduleFromFile(file);
          
          if(processing){
            document.body.removeChild(processing);
            processing = null;
          }
          
          fileInput.value = ''; // Reset input
          if(fileInputText) fileInputText.textContent = 'Wybierz plik JSON lub XLSX';
          
          // Aktywuj nowy harmonogram automatycznie
          if(newSchedule){
            activeScheduleId = newSchedule.id;
            saveSchedulesToStorage();
            renderScheduleList();
            loadData(); // Za≈Çaduj nowy harmonogram
          }
          
          // Poka≈º komunikat sukcesu (zamiast alert)
          const successMsg = document.createElement('div');
          successMsg.id = 'successOverlay';
          successMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(11,16,32,0.95); padding: 20px 40px; border-radius: 12px; color: white; z-index: 10001; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.4);';
          successMsg.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
            <div style="font-size: 16px; margin-bottom: 8px; font-weight: bold;">Harmonogram dodany pomy≈õlnie!</div>
            <div style="font-size: 13px; opacity: 0.7;">${newSchedule ? 'Automatycznie aktywowany' : ''}</div>
          `;
          document.body.appendChild(successMsg);
          
          // Usu≈Ñ po 2 sekundach
          setTimeout(() => {
            successMsg.style.transition = 'opacity 0.3s';
            successMsg.style.opacity = '0';
            setTimeout(() => {
              if(document.body.contains(successMsg)){
                document.body.removeChild(successMsg);
              }
            }, 300);
          }, 2000);
        }catch(err){
          console.error('B≈ÇƒÖd dodawania harmonogramu:', err);
          
          if(processing){
            document.body.removeChild(processing);
          }
          
          alert('‚ùå ' + err.message);
          fileInput.value = '';
          if(fileInputText) fileInputText.textContent = 'Wybierz plik JSON lub XLSX';
        }
      });
      
      // Obs≈Çuga dodawania z URL
      const addUrlBtn = document.getElementById('addUrlBtn');
      const urlInput = document.getElementById('urlInput');
      
      if(addUrlBtn && urlInput){
        // Obs≈Çuga przycisku
        addUrlBtn.addEventListener('click', async () => {
          const url = urlInput.value.trim();
          
          if(!url){
            urlInput.focus();
            urlInput.style.borderColor = 'rgba(255, 90, 90, 0.5)';
            setTimeout(() => {
              urlInput.style.borderColor = 'rgba(255,255,255,0.1)';
            }, 1500);
            return;
          }
          
          try {
            await addScheduleFromURL(url);
            urlInput.value = ''; // Wyczy≈õƒá input po sukcesie
          } catch(error) {
            console.error('B≈ÇƒÖd dodawania z URL:', error);
            alert('‚ùå ' + error.message);
          }
        });
        
        // Obs≈Çuga Enter w polu URL
        urlInput.addEventListener('keypress', (e) => {
          if(e.key === 'Enter'){
            addUrlBtn.click();
          }
        });
        
        // Reset stylu inputa przy wpisywaniu
        urlInput.addEventListener('input', () => {
          urlInput.style.borderColor = 'rgba(255,255,255,0.1)';
        });
      }
    });
    
    // Make functions global
    window.switchSchedule = switchSchedule;
    window.confirmDeleteSchedule = confirmDeleteSchedule;
    window.refreshScheduleUrl = refreshScheduleUrl;
    
    // ===== KONIEC SYSTEMU ZARZƒÑDZANIA =====

    // Funkcja do dynamicznego dostosowywania widoku
    function getDayMax(){
      const w = window.innerWidth;
      if(w <= 480) return 4;
      if(w <= 700) return 5;
      if(w <= 900) return 6;
      return 6;
    }

    // Debounce function - op√≥≈∫nia wykonanie funkcji do momentu gdy u≈ºytkownik przestanie zmieniaƒá rozmiar
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // ZMIANA: Uproszczona funkcja resize, g≈Ç√≥wnie do ustawiania zmiennej CSS
    function handleResize(){
      const header = document.querySelector('header');
      const headerHeight = header ? header.offsetHeight : 65;
      document.documentElement.style.setProperty('--header-h', `${headerHeight}px`);
      
      if(fc){
        fc.setOption('dayMaxEventRows', getDayMax());
        // Wymuszenie przeliczenia rozmiaru kalendarza przy zmianie rozmiaru okna
        fc.updateSize();
      }
    }

    // Wersja z debouncing dla p≈Çynniejszego dzia≈Çania
    const debouncedResize = debounce(handleResize, 150);

    async function loadData() {
      try {
        await loadSchedulesFromStorage();
        const activeSchedule = getActiveSchedule();
        
        if(!activeSchedule){
          throw new Error('Brak aktywnego harmonogramu');
        }
        
        // Load from stored data or fetch from path
        if(activeSchedule.data){
          rawData = activeSchedule.data;
        } else {
          // Sprawd≈∫ czy to plik XLSX czy JSON
          const isXlsx = activeSchedule.path.toLowerCase().endsWith('.xlsx') || 
                        activeSchedule.path.toLowerCase().endsWith('.xlsm');
          
          let res;
          try {
            // Pr√≥ba pobrania bezpo≈õrednio
            res = await fetch(activeSchedule.path, { 
              cache: 'no-store',
              mode: 'cors'
            });
            
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
          } catch (corsError) {
            console.warn('‚ö†Ô∏è B≈ÇƒÖd CORS, pr√≥ba u≈ºycia CORS proxy...', corsError);
            
            // Je≈õli CORS nie zadzia≈Ça≈Ç, spr√≥buj przez proxy
            const corsProxy = 'https://corsproxy.io/?';
            const proxiedUrl = corsProxy + encodeURIComponent(activeSchedule.path);
            
            res = await fetch(proxiedUrl, { 
              cache: 'no-store'
            });
            
            if (!res.ok) {
              throw new Error(`Nie uda≈Ço siƒô pobraƒá pliku (status: ${res.status}). Sprawd≈∫ po≈ÇƒÖczenie z internetem.`);
            }
          }
          
          if(isXlsx){
            // Parsuj XLSX
            const arrayBuffer = await res.arrayBuffer();
            rawData = await parseXLSXToEvents(arrayBuffer, activeSchedule.name);
          } else {
            // Parsuj JSON
            rawData = await res.json();
          }
        }
        
        rawData.events = (rawData.events || []).map(e => normalizeEvent(e));
        
        // Update schedule status
        const validation = await validateScheduleFile(rawData, activeSchedule.name);
        const scheduleIndex = schedules.findIndex(s => s.id === activeSchedule.id);
        if(scheduleIndex !== -1){
          schedules[scheduleIndex].status = validation.valid ? 'success' : (validation.errors.length > 0 ? 'error' : 'warning');
          schedules[scheduleIndex].eventsCount = validation.eventsCount;
          schedules[scheduleIndex].errors = validation.errors;
          schedules[scheduleIndex].warnings = validation.warnings || [];
          saveSchedulesToStorage();
        }
        
        statElements.total.textContent = rawData.events.length;
        initFilters(rawData.events);
        initCalendar(rawData.events);
        applyFilters();
        handleResize();
      } catch (error) {
        console.error("Nie uda≈Ço siƒô za≈Çadowaƒá danych:", error);
        calendarEl.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 20px;">B≈ÇƒÖd ≈Çadowania harmonogramu: ${error.message}<br><br>Kliknij przycisk ? aby zarzƒÖdzaƒá harmonogramami.</p>`;
      }
    }

    function normalizeEvent(e){
      const out = { ...e };
      if(!out.title && out.raw){ out.title = (String(out.raw).split(/\n|\r/)[0] || '').trim(); }
      if(out.isRemote || out.color === 'red') out.classNames = ['remote'];
      if(out.date && out.startTime){ out.start = out.date + 'T' + out.startTime; }
      if(out.date && out.endTime){ out.end = out.date + 'T' + out.endTime; }
      return out;
    }
    
    function unique(values){ return [...new Set(values.filter(Boolean))].sort(); }

    function initFilters(events){
      // POPRAWKA: Wyczy≈õƒá wszystkie filtry zachowujƒÖc tylko domy≈õlnƒÖ opcjƒô "Wszystkie"
      Object.values(filterElements).forEach(selectEl => {
        const defaultOption = selectEl.querySelector('option[value=""]');
        selectEl.innerHTML = ''; // Wyczy≈õƒá wszystkie opcje
        if(defaultOption) {
          selectEl.appendChild(defaultOption.cloneNode(true)); // Przywr√≥ƒá domy≈õlnƒÖ opcjƒô
        } else {
          // Je≈õli nie ma domy≈õlnej opcji, stw√≥rz jƒÖ
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = selectEl.id === 'lecturer' ? 'Wszyscy' : 'Wszystkie';
          selectEl.appendChild(opt);
        }
      });
      
      const populateSelect = (selectEl, values) => {
        for(const val of unique(values)){
          const o = document.createElement('option'); o.value=o.textContent=val; selectEl.appendChild(o);
        }
      };
      
      populateSelect(filterElements.program, events.map(e => e.program));
      // Automatyczne wykrywanie typu, je≈õli nie jest podany
      const typeSet = new Set(events.map(e=>e.type).filter(Boolean));
      if(typeSet.size === 0) {
        events.forEach(e => {
          const t = (e.raw||'').toUpperCase();
          if(t.includes(' LAB')) e.type='LAB';
          else if(t.includes(' PROJEKT')) e.type='PROJEKT';
          else if(/\bW\b/.test(t) || t.includes(' W\n')) e.type='W';
          else if(t.includes(' ƒÜW') || t.includes(' ?W')) e.type='ƒÜW';
        });
      }
      populateSelect(filterElements.type, events.map(e => e.type));
      populateSelect(filterElements.room, events.map(e => e.location));
      
      // Wyk≈Çadowcy - sp≈Çaszczenie tablic
      const allLecturers = events.flatMap(e => e.lecturers || []);
      populateSelect(filterElements.lecturer, allLecturers);

      // ≈Åadowanie zapisanych filtr√≥w
      try{
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        for (const key in saved) {
          if (filterElements[key] && saved[key] && [...filterElements[key].options].some(o => o.value === saved[key])) {
            filterElements[key].value = saved[key];
          }
        }
      }catch(e){ console.warn("Nie uda≈Ço siƒô za≈Çadowaƒá filtr√≥w z LocalStorage", e); }

      // Event Listeners
      Object.values(filterElements).forEach(el=> el.addEventListener('change', () => {
        saveFilters();
        applyFilters();
      }));
      document.getElementById('reset').addEventListener('click', ()=>{
        Object.values(filterElements).forEach(el => el.value = '');
        saveFilters();
        applyFilters();
      });
      
      // ZMIANA: Uproszczone prze≈ÇƒÖczanie widok√≥w
      viewButtons.forEach(button => {
        button.addEventListener('click', () => switchView(button.dataset.view));
      });
      
      // U≈ºywamy debounced wersji dla resize, ale natychmiastowej dla orientationchange
      window.addEventListener('resize', debouncedResize);
      window.addEventListener('orientationchange', handleResize);
      
      // Wywo≈Çaj raz na starcie, aby upewniƒá siƒô ≈ºe wszystko jest dobrze ustawione
      handleResize();
    }
    
    function saveFilters(){
      const data = { 
        program: filterElements.program.value, 
        type: filterElements.type.value, 
        room: filterElements.room.value,
        lecturer: filterElements.lecturer.value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function switchView(viewName){
      if(!fc) return;
      fc.changeView(viewName);
      viewButtons.forEach(button => {
        button.setAttribute('aria-pressed', String(button.dataset.view === viewName));
      });
      // Nie ma potrzeby save/apply/resize tutaj, bo to siƒô dzieje w 'datesSet'
    }

    function initCalendar(events){
      if(fc) fc.destroy();
      const isMobile = window.innerWidth <= 900;
      fc = new FullCalendar.Calendar(calendarEl, {
        locale: 'pl', firstDay: 1, initialView: 'dayGridMonth',
        // ZMIANA: Kluczowa zmiana pozwalajƒÖca na naturalny wzrost kalendarza i scroll strony
        height: isMobile ? 'auto' : 'auto',
        contentHeight: isMobile ? 'auto' : undefined,
        events: [],
        displayEventEnd: true,
        dayMaxEventRows: getDayMax(),
        fixedWeekCount: false,
        showNonCurrentDates: true, // Zmienione na true, bo CSS je styluje, a to lepsze dla nawigacji
        moreLinkClick: isMobile ? 'popover' : 'popover',
        dayMaxEvents: isMobile,
        allDaySlot: false,
        handleWindowResize: false, // Kontrolujemy resize rƒôcznie
        slotDuration: '00:15:00',
        slotLabelInterval: '01:00:00',
        slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        slotMinTime: '08:00:00',
        slotMaxTime: '21:30:00',
        expandRows: true,
        nowIndicator: true,
        eventContent: arg => {
          const e = arg.event.extendedProps;
          const time = (e.startTime && e.endTime) ? `${e.startTime}‚Äì${e.endTime}` : '';
          const title = (arg.event.title || '').trim();
          const html = `<div class="evt"><span class="t">${escapeHtml(title)}</span>${time ? `<span class="tm">${time}</span>`:''}</div>`;
          return { html };
        },
        eventDidMount: info => {
          info.el.addEventListener('mouseenter', ()=> showTooltip(info.el, buildTooltipHtml(info.event.extendedProps, info.event.classNames.includes('remote'))));
          info.el.addEventListener('mouseleave', hideTooltip);
        },
        moreLinkContent: arg => {
          return { html: `<span style="font-weight: 700; color: var(--accent);">+${arg.num} wiƒôcej</span>` };
        },
        moreLinkDidMount: info => {
          // Dodaj styl hover dla linku "+XX wiƒôcej"
          info.el.style.transition = 'all 0.2s';
          info.el.addEventListener('mouseenter', () => {
            info.el.style.transform = 'translateY(-1px)';
            info.el.style.textDecoration = 'none';
          });
          info.el.addEventListener('mouseleave', () => {
            info.el.style.transform = 'translateY(0)';
          });
        },
        datesSet: () => { 
          applyFilters(); 
          handleResize(); 
        },
      });
      fc.render();
    }
    
    function buildTooltipHtml(e, isRemote){
      const rows = [];
      const addRow = (label, value) => {
        if(value) rows.push(`<div class="tt-row"><span>${label}:</span><b>${escapeHtml(value)}</b></div>`);
      };

      if(e.title) rows.push(`<div class="tt-title">${escapeHtml(e.title)}</div>`);
      addRow('Data', e.date);
      addRow('Godziny', e.startTime && e.endTime ? `${e.startTime}‚Äì${e.endTime}` : e.startTime);
      addRow('Program', e.program);
      addRow('Typ', e.type);
      addRow('Sala', e.location);
      addRow('ProwadzƒÖcy', e.lecturers?.join(', '));
      addRow('Zjazd', e.zjazd);
      
      if(isRemote) rows.push(`<div class="tt-badge tt-remote">Zajƒôcia zdalne</div>`);
      return rows.join('');
    }

    function escapeHtml(str){
      return String(str||'').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    function showTooltip(el, html){
      if (!html) return;
      tooltip.innerHTML = html;
      tooltip.style.display = 'block';
      requestAnimationFrame(() => {
        tooltip.style.opacity = '1';
        const rect = el.getBoundingClientRect();
        const pad = 8;
        
        let left = rect.left + (rect.width/2) - (tooltip.offsetWidth/2);
        left = Math.max(10, Math.min(left, window.innerWidth - tooltip.offsetWidth - 10));
        
        let top = rect.top - tooltip.offsetHeight - pad;
        if(top < 10){ top = rect.bottom + pad; }
        
        tooltip.style.transform = `translate(${left}px, ${top}px)`;
      });
    }

    function hideTooltip(){ 
      tooltip.style.opacity = '0';
      // Czekamy na koniec animacji zanim ukryjemy element
      setTimeout(() => {
        if (tooltip.style.opacity === '0') {
          tooltip.style.display = 'none';
        }
      }, 150);
    }
    
    // ZMIANA: Ustawienie transform zamiast top/left dla p≈Çynniejszej animacji i wydajno≈õci
    tooltip.style.top = '0';
    tooltip.style.left = '0';

    let lastFiltered = [];
    let nextTimerId;

    const nextEls = {
      card: null, status: null, badge: null, title: null, range: null, room: null, bar: null
    };

    document.addEventListener('DOMContentLoaded', ()=>{
      nextEls.card = document.getElementById('nextCard');
      nextEls.status = document.getElementById('nextStatus');
      nextEls.badge = document.getElementById('nextBadge');
      nextEls.title = document.getElementById('nextTitle');
      nextEls.range = document.getElementById('nextRange');
      nextEls.room = document.getElementById('nextRoom');
      nextEls.bar = document.getElementById('nextProgress');
    });

    function humanizeMinutes(mins){
      const m = Math.max(0, Math.round(mins));
      const d = Math.floor(m / 1440);
      const h = Math.floor((m % 1440) / 60);
      const mm = m % 60;
      if(d>0 && h>0) return `${d} d ${h} h`;
      if(d>0) return `${d} d`;
      if(h>0 && mm>0) return `${h} h ${mm} min`;
      if(h>0) return `${h} h`;
      return `${mm} min`;
    }

    function fmtHM(d){ return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

    function ensureEndISO(ev){
      if(ev.end) return ev.end;
      // domy≈õlnie +60 min gdy brak ko≈Ñca
      const d = new Date(ev.start);
      d.setMinutes(d.getMinutes()+60);
      return d.toISOString();
    }

    function pickNextOrCurrent(events){
      const now = new Date();
      const enriched = events
        .filter(e=>e.start)
        .map(e=>({
          e,
          start: new Date(e.start),
          end: new Date(ensureEndISO(e))
        }))
        .filter(x=>!isNaN(x.start) && !isNaN(x.end))
        .sort((a,b)=> a.start - b.start);

      const ongoing = enriched.filter(x=> now >= x.start && now < x.end)
                              .sort((a,b)=> a.end - b.end);
      if(ongoing.length) return { kind:'ongoing', ...ongoing[0] };

      const upcoming = enriched.filter(x=> x.start > now);
      if(upcoming.length) return { kind:'upcoming', ...upcoming[0] };

      return null;
    }

    function updateNextTile(){
      if(!nextEls.card) return;
      const pick = pickNextOrCurrent(lastFiltered);
      if(!pick){
        nextEls.card.classList.remove('remote');
        nextEls.status.textContent = 'Brak nadchodzƒÖcych zajƒôƒá';
        nextEls.badge.style.display = 'none';
        nextEls.title.textContent = '‚Äî';
        nextEls.range.textContent = '‚Äî';
        nextEls.room.textContent = '';
        nextEls.bar.style.width = '0%';
        nextEls.bar.parentElement.setAttribute('aria-valuenow','0');
        return;
      }

      const { e, start, end, kind } = pick;
      const isRemote = (e.classNames||[]).includes('remote');
      nextEls.card.classList.toggle('remote', isRemote);
      nextEls.badge.style.display = isRemote ? '' : 'none';

      // Tytu≈Ç, godziny, sala
      nextEls.title.textContent = (e.title||'Zajƒôcia');
      nextEls.range.textContent = `${fmtHM(start)}‚Äì${fmtHM(end)}`;
      nextEls.room.textContent = e.location ? `‚Ä¢ ${e.location}` : (isRemote ? '‚Ä¢ Zdalnie' : '');

      const totalMin = (end - start)/60000;
      const leftToStart = (start - new Date())/60000;

      if(kind==='ongoing'){
        const elapsed = (new Date() - start)/60000;
        const pct = Math.max(0, Math.min(100, (elapsed/totalMin)*100));
        nextEls.status.textContent = `TrwajƒÖ ¬∑ do ko≈Ñca ${humanizeMinutes(totalMin - elapsed)}`;
        nextEls.bar.style.width = pct.toFixed(1)+'%';
        nextEls.bar.parentElement.setAttribute('aria-valuenow', String(Math.round(pct)));
      }else{
        nextEls.status.textContent = `Nastƒôpne za ${humanizeMinutes(leftToStart)}`;
        nextEls.bar.style.width = '0%';
        nextEls.bar.parentElement.setAttribute('aria-valuenow','0');
      }
    }

    function startNextTimer(){
      clearInterval(nextTimerId);
      nextTimerId = setInterval(updateNextTile, 30000); // od≈õwie≈ºaj co 30s
    }



    function applyFilters(){
      const fProg = filterElements.program.value;
      const fType = filterElements.type.value;
      const fRoom = filterElements.room.value;
      const fLecturer = filterElements.lecturer.value;

      const filtered = rawData.events.filter(ev => {
        if(fProg && ev.program !== fProg) return false;
        if(fType && ev.type !== fType) return false;
        if(fRoom && ev.location !== fRoom) return false;
        if(fLecturer && (!ev.lecturers || !ev.lecturers.includes(fLecturer))) return false;
        return true;
      });

      lastFiltered = filtered; // zapisz aktualnie przefiltrowane wydarzenia

      fc.removeAllEvents();
      fc.addEventSource(filtered.map(e => ({
        title: e.title || (e.raw||'').slice(0,60),
        start: e.start,
        end: e.end,
        classNames: e.classNames,
        extendedProps: e,
      })));

      statElements.visible.textContent = filtered.length;
      updateNextTile();
      startNextTimer();
    }

    // Pomocnicze funkcje dla ICS
    function addMinutesLocalIso(dtStr, minutes){
      const d = new Date(dtStr);
      d.setMinutes(d.getMinutes() + (minutes||0));
      return d.toISOString();
    }

    function icsEscape(str){
      return String(str||'')
        .replace(/\\/g,'\\\\')
        .replace(/\n/g,'\\n')
        .replace(/,/g,'\\,')
        .replace(/;/g,'\\;');
    }

    function simpleHash(s){
      let h = 0; 
      for(let i=0;i<s.length;i++){ 
        h = ((h<<5) - h) + s.charCodeAt(i); 
        h |= 0; 
      }
      return Math.abs(h).toString(36);
    }

    // Pomocnicze: sk≈Çadanie linii ICS do 75 znak√≥w (RFC 5545)
    function foldIcsLine(line){
      const maxLen = 75;
      if(line.length <= maxLen) return line;
      let out = '';
      for(let i=0; i<line.length; i+=maxLen){
        const chunk = line.slice(i, i+maxLen);
        out += (i===0 ? chunk : `\r\n ${chunk}`);
      }
      return out;
    }
    function foldIcs(lines){ return lines.map(foldIcsLine).join('\r\n'); }

    // Format daty w UTC do ICS: YYYYMMDDTHHMMSSZ
    function toIcsUtc(dt){
      const d = (dt instanceof Date) ? dt : new Date(dt);
      const y = d.getUTCFullYear();
      const M = String(d.getUTCMonth()+1).padStart(2,'0');
      const D = String(d.getUTCDate()).padStart(2,'0');
      const h = String(d.getUTCHours()).padStart(2,'0');
      const m = String(d.getUTCMinutes()).padStart(2,'0');
      const s = String(d.getUTCSeconds()).padStart(2,'0');
      return `${y}${M}${D}T${h}${m}${s}Z`;
    }

    function buildICS(events){
      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//MUP Harmonogram//PL',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH'
      ];
      const stamp = toIcsUtc(new Date());
      events.forEach((e)=>{
        if(!e.start) return; // wymagany DTSTART
        const startUtc = toIcsUtc(e.start);
        const endUtc = toIcsUtc(e.end || addMinutesLocalIso(e.start, 60));
        const title = icsEscape(e.title || 'Zajƒôcia');
        const lecturers = (e.lecturers && e.lecturers.length) ? `ProwadzƒÖcy: ${e.lecturers.join(', ')}` : '';
        const parts = [
          e.program ? `Program: ${e.program}` : '',
          e.type ? `Typ: ${e.type}` : '',
          e.location ? `Sala: ${e.location}` : ((e.classNames||[]).includes('remote') ? 'Zdalnie' : ''),
          lecturers,
          e.zjazd ? `Zjazd: ${e.zjazd}` : '',
        ].filter(Boolean);
        const desc = icsEscape(parts.join('\n'));
        const loc = icsEscape(e.location || ((e.classNames||[]).includes('remote') ? 'Zdalnie' : ''));
        const uid = simpleHash(`${e.start}|${e.end}|${e.title||''}|${e.location||''}`) + '@mup';

        lines.push('BEGIN:VEVENT');
        if(stamp) lines.push(`DTSTAMP:${stamp}`);
        lines.push(`UID:${uid}`);
        lines.push(`DTSTART:${startUtc}`);
        if(endUtc) lines.push(`DTEND:${endUtc}`);
        lines.push(`SUMMARY:${title}`);
        if(desc) lines.push(`DESCRIPTION:${desc}`);
        if(loc) lines.push(`LOCATION:${loc}`);
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      return foldIcs(lines) + '\r\n';
    }

    function exportToGoogleCalendar(){
      const events = lastFiltered || [];
      const btn = document.getElementById('exportGoogle');
      if(!events.length){
        if(btn){ btn.classList.add('shiver'); setTimeout(()=>btn.classList.remove('shiver'), 300); }
        return;
      }
      try{
        const ics = buildICS(events);
        const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'harmonogram_przefiltrowany.ics';
        document.body.appendChild(a);
        a.click();
        a.remove();
        // op√≥≈∫nij revoke, by uniknƒÖƒá anulowania pobrania w niekt√≥rych przeglƒÖdarkach
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      }catch(err){
        console.error('Eksport ICS nie powi√≥d≈Ç siƒô', err);
        if(btn){ btn.classList.add('shiver'); setTimeout(()=>btn.classList.remove('shiver'), 600); }
      }
    }

    // Obs≈Çuga mapy kampusu
    function initCampusMap(){
      const buildings = document.querySelectorAll('.building-area');
      const mapContainer = document.querySelector('.map-container');
      
      if(!buildings.length || !mapContainer) return;
      
      buildings.forEach(building => {
        const code = building.dataset.building;
        const label = document.getElementById(`label-${code}`);
        
        if(!label) return;
        
        building.addEventListener('mouseenter', (e) => {
          // Poka≈º tooltip
          label.classList.add('visible');
          
          // Pozycjonuj tooltip
          const rect = building.getBoundingClientRect();
          const containerRect = mapContainer.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2 - containerRect.left;
          const centerY = rect.top - containerRect.top;
          
          label.style.left = centerX + 'px';
          label.style.top = centerY + 'px';
        });
        
        building.addEventListener('mouseleave', () => {
          label.classList.remove('visible');
        });
      });
    }

    // Podpiƒôcie przycisku eksportu i inicjalizacja
    document.addEventListener('DOMContentLoaded', ()=>{
      const exportBtn = document.getElementById('exportGoogle');
      if(exportBtn){ exportBtn.addEventListener('click', exportToGoogleCalendar); }
      
      // Inicjalizacja mapy kampusu
      initCampusMap();
    });

    // Asynchroniczne uruchomienie aplikacji
    (async () => {
      await loadSchedulesFromStorage();
      await loadData();
    })();
  </script>
</body>
</html>