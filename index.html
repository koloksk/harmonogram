<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Harmonogram</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.css">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" type="image/png" href="./logo.png">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MUP">
  <meta name="theme-color" content="#0b1020">
  
  <!-- Service Worker - rejestracja od razu, bez czekania! -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('✅ Service Worker zarejestrowany:', reg))
        .catch(err => console.error('❌ Błąd rejestracji SW:', err));
    }
  </script>
  
  <style>
    :root{
      --bg:#0b1020; --panel:#0f152b; --muted:#9aa1b2; --text:#e8ecf1; --accent:#7c9cff; --chip:#1b2340; --border:#1f2642;
      --danger:#ff5a5a; --event:#203057; --event-border:#2b3b6a; --event-text:#e3e9ff; --event-remote:#ffb3b3;
      --header-h: 65px; /* Domyślna wysokość nagłówka */
    }
    *{box-sizing:border-box}
    
    /* ZMIANA: Usunięto overflow:hidden i height:100dvh, dodano min-height i płynne przewijanie */
    html{ scroll-behavior: smooth; }
    body{
      margin:0; 
      min-height:100dvh;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; 
      background:var(--bg); 
      color:var(--text);
    }
    
    /* ZMIANA: Header jest teraz w pełni 'fixed' i nie blokuje reszty strony */
    header{
      display:flex; align-items:center; justify-content:space-between; 
      padding:16px 20px; 
      border-bottom:1px solid var(--border); 
      position:fixed; top:0; left:0; right:0; 
      height: var(--header-h);
      background:linear-gradient(180deg, #0b1020 0%, rgba(11,16,32,0.9) 100%); 
      backdrop-filter:saturate(120%) blur(6px); 
      z-index:10;
    }
    header h1{font-size:18px; margin:0; letter-spacing:.3px}
    .seg{display:flex; gap:6px; background:#0c1330; border:1px solid var(--border); padding:4px; border-radius:999px}
    .seg button{background:transparent; color:var(--text); border:0; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px; transition: background 0.2s, color 0.2s;}
    .seg button[aria-pressed="true"]{background:var(--accent); color:#0a0f21}

    /* ZMIANA: `main` nie jest już absolutnie pozycjonowany. Ma padding, by nie chować się pod headerem. */
    main{
      padding: calc(var(--header-h) + 16px) 16px 16px;
      display:grid; 
      grid-template-columns: 320px 1fr; 
      gap:16px;
      align-items: start; /* Ważne dla sticky sidebar */
    }

    /* ZMIANA: Nowy breakpoint dla lepszej responsywności na tabletach */
    @media (max-width: 1100px){
      main{ grid-template-columns: 280px 1fr; }
    }
    @media (max-width: 900px){ 
      main{
        grid-template-columns: 1fr; 
        padding-left: 12px;
        padding-right: 12px;
      } 
    }

    /* ZMIANA: Sidebar jest "lepki" na desktopie i ma własny scroll w razie potrzeby */
    aside{
      background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px;
      position: sticky;
      top: calc(var(--header-h) + 16px);
      max-height: calc(100vh - var(--header-h) - 32px); /* Ograniczenie wysokości */
      overflow-y: auto; /* Scrollbar jeśli filtry się nie mieszczą */
    }
    #calendar{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:8px;}

    .section-title{margin:4px 0 10px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.08em}
    .filters{display:grid; gap:10px}
    .group{display:grid; gap:6px; background:#0c1330; border:1px solid var(--border); padding:10px; border-radius:12px}
    label{font-size:12px; color:var(--muted)}
    select, button.reset{appearance:none; border:1px solid #2a335a; background:#0e1430; color:var(--text); padding:10px 12px; border-radius:10px; font-size:13px; width:100%;}
    button.reset{background:var(--accent); color:#0a0f21; border:0; font-weight:700; cursor:pointer}

    .stats{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:16px}
    .card{background:#0d1430; border:1px solid var(--border); border-radius:12px; padding:10px}
    .card h3{margin:0 0 6px; font-size:12px; color:var(--muted)}
    .card .value{font-size:18px; font-weight:700}

    /* FullCalendar dopracowanie */
    .fc{--fc-border-color:#223057; --fc-page-bg-color:transparent; --fc-neutral-bg-color:#0f152b; --fc-list-event-hover-bg-color:#141b36;}
    .fc .fc-toolbar-title{font-size:18px; font-weight:700; color:var(--text)}
    .fc .fc-button{background:linear-gradient(180deg, #1a2447 0%, #0f1a3d 100%); border:1px solid #2a335a; color:var(--text); font-weight:600; border-radius:8px; padding:8px 14px; transition: all 0.2s;}
    .fc .fc-button:hover{background:linear-gradient(180deg, #22305d 0%, #162244 100%); border-color:#3a4a7a; transform:translateY(-1px)}
    .fc .fc-button:active{transform:translateY(0)}
    .fc .fc-button-primary:not(:disabled).fc-button-active{background:linear-gradient(180deg, var(--accent) 0%, #5a7ee6 100%); color:#fff; border-color:var(--accent)}
    .fc-theme-standard .fc-scrollgrid{border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .fc .fc-daygrid-day, .fc .fc-timegrid-slot{background:#0f152b}
    .fc .fc-daygrid-day-number{color:var(--muted); font-weight:600; font-size:13px; padding:6px}
    .fc .fc-col-header-cell{background:linear-gradient(180deg, #0d1430 0%, #0b1026 100%); border-color:var(--border); font-weight:700; color:var(--text); padding:10px 4px; font-size:13px}
    .fc .fc-daygrid-day.fc-day-today{background:rgba(124,156,255,0.08)}
    .fc .fc-daygrid-day.fc-day-today .fc-daygrid-day-number{color:var(--accent); font-weight:700}
    
    /* Wydarzenia z gradientami */
    .fc .fc-daygrid-event, .fc .fc-timegrid-event{
      border-radius:8px; 
      border:1px solid rgba(124,156,255,0.3); 
      background:linear-gradient(135deg, rgba(32,48,87,0.9) 0%, rgba(20,35,70,0.9) 100%);
      overflow:hidden;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .fc .fc-daygrid-event:hover, .fc .fc-timegrid-event:hover{
      transform:translateY(-2px);
      box-shadow: 0 4px 12px rgba(124,156,255,0.3);
      border-color:rgba(124,156,255,0.5);
    }
    .fc .fc-daygrid-event{padding:5px 8px; min-height:28px}
    .fc .fc-timegrid-event .fc-event-main{display:flex; align-items:center; justify-content:center; padding:6px 10px; height:100%}
    .fc .fc-daygrid-event .evt, .fc .fc-timegrid-event .evt{
      display:flex; 
      flex-direction:column; 
      align-items:center; 
      justify-content:center; 
      gap:2px; 
      min-width:0; 
      line-height:1.3; 
      text-align:center; 
      width:100%
    }
    .fc .fc-daygrid-event .t, .fc .fc-timegrid-event .t{
      flex:0 0 auto; 
      min-width:0; 
      font-weight:700; 
      font-size:14px; 
      color:#e8ecf1;
      white-space:normal; 
      overflow:hidden; 
      text-overflow:ellipsis; 
      word-break:break-word;
      display:-webkit-box; 
      -webkit-box-orient:vertical; 
      -webkit-line-clamp:3; 
      line-clamp:3;
    }
    .fc .fc-daygrid-event .tm, .fc .fc-timegrid-event .tm{font-size:12px; color:#b8c5ff; font-weight:600}
    
    /* Kompaktowy widok komórek na mobile */
    @media (max-width: 900px){
      .fc .fc-daygrid-body{font-size:0.9em}
      .fc .fc-scrollgrid{font-size:inherit}
    }
    
    /* Wydarzenia zdalne - czerwony gradient */
    .fc .fc-daygrid-event.remote, .fc .fc-timegrid-event.remote{
      background:linear-gradient(135deg, rgba(255,65,65,0.2) 0%, rgba(200,40,40,0.2) 100%); 
      border-color:rgba(255,65,65,0.4);
    }
    .fc .fc-daygrid-event.remote:hover, .fc .fc-timegrid-event.remote:hover{
      border-color:rgba(255,65,65,0.6);
      box-shadow: 0 4px 12px rgba(255,65,65,0.3);
    }

    /* Wyraźniejsze godziny */
    .fc .fc-timegrid-axis{background:#0e1430}
    .fc .fc-timegrid-slot, .fc .fc-timegrid-slot-lane{border-top-color:#1a2447}
    .fc .fc-timegrid-slot:not(.fc-timegrid-slot-minor),
    .fc .fc-timegrid-slot-lane:not(.fc-timegrid-slot-minor){border-top:1px solid #24335d}
    .fc .fc-timegrid-slot.fc-timegrid-slot-main,
    .fc .fc-timegrid-slot-lane.fc-timegrid-slot-main{border-top:2px solid #4a6bff}
    
    /* ZMIANA: Usunięto problematyczne hacki na ukrywanie scrollbarów FullCalendar */

    /* Nie pokazuj zawartości dni spoza bieżącego miesiąca w widoku miesięcznym */
    .fc .fc-daygrid-day.fc-day-other{ background:#0b1020; pointer-events: none; }
    .fc .fc-daygrid-day.fc-day-other .fc-daygrid-day-top { opacity: 0.3; }

    /* Mobile ulepszenia */
    @media (max-width: 900px){
      main{
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      /* Na mobile: kafelek wychodzi poza sidebar i idzie na górę */
      .next-card{
        order: -3;
        margin: 0 0 16px 0;
        max-width: 600px;
        width: 100%;
      }
      /* Kalendarz pod kafelkiem */
      #calendar{
        order: -2;
        margin-bottom: 16px;
        width: 100%;
      }
      /* Sidebar (bez kafelka który jest wyżej) na dole */
      aside{
        position: static;
        max-height: none;
        order: -1;
        display: contents; /* Dzieci sidebara traktowane jak bezpośrednie dzieci main */
      }
      /* Filtry, stats i export z max-width */
      .filters, .stats, .export, .section-title{
        max-width: 600px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
      
      .fc .fc-toolbar{flex-wrap:wrap; gap:8px}
      .fc .fc-toolbar-chunk{margin:4px 0}
    }
    @media (max-width: 700px){
      .fc .fc-toolbar-title{font-size:15px}
      .fc .fc-button{padding:5px 8px; font-size:11px}
      .fc .fc-daygrid-event{padding:3px 5px; min-height:auto; margin:1px 0}
      .fc .fc-daygrid-event .evt{gap:0px; align-items:flex-start; text-align:left}
      .fc .fc-daygrid-event .t{font-size:10px; -webkit-line-clamp:2; line-clamp:2; font-weight:700; line-height:1.3}
      .fc .fc-daygrid-event .tm{font-size:9px; opacity:0.8}
      .fc .fc-daygrid-day-number{font-size:11px; padding:3px 5px; font-weight:700}
      .fc .fc-col-header-cell{padding:5px 2px; font-size:10px}
      .fc .fc-daygrid-day-frame{min-height:55px !important}
      .fc .fc-scrollgrid-sync-table{height:auto !important}
      .fc .fc-daygrid-day-top{padding:2px}
      
      /* Widok tygodniowy - kompaktowy */
      .fc .fc-timegrid-axis{font-size:8px; padding:0 1px; width:30px}
      .fc .fc-timegrid-slot{height:16px}
      .fc .fc-timegrid-slot-label{font-size:7px; padding:0 1px; line-height:1}
      .fc .fc-timegrid-event{padding:1px 2px; margin:0 0.5px; border-width:1px}
      .fc .fc-timegrid-event .fc-event-main{padding:1px 2px}
      .fc .fc-timegrid-event .evt{gap:0; align-items:flex-start; text-align:left}
      .fc .fc-timegrid-event .t{font-size:9px; line-height:1.15; font-weight:700; word-break:break-word; white-space:normal; letter-spacing:-0.01em}
      .fc .fc-timegrid-event .tm{font-size:7px; opacity:0.8; font-weight:600}
      .fc .fc-timegrid-col-events{margin:0 0.5px}
      .fc .fc-timegrid-divider{height:0px; display:none}
      
      /* Widok dzienny - ładniejszy na mobile */
      .fc-timeGridDay-view .fc-timegrid-axis{font-size:10px; padding:0 4px; width:45px}
      .fc-timeGridDay-view .fc-timegrid-slot{height:35px}
      .fc-timeGridDay-view .fc-timegrid-slot-label{font-size:10px; padding:2px; line-height:1.2}
      .fc-timeGridDay-view .fc-timegrid-event{padding:4px 8px; margin:0 2px; border-width:1px; border-radius:8px}
      .fc-timeGridDay-view .fc-timegrid-event .fc-event-main{padding:4px 8px}
      .fc-timeGridDay-view .fc-timegrid-event .evt{gap:2px; align-items:center; text-align:center; justify-content:center}
      .fc-timeGridDay-view .fc-timegrid-event .t{font-size:13px; line-height:1.3; font-weight:700; word-break:break-word; white-space:normal}
      .fc-timeGridDay-view .fc-timegrid-event .tm{font-size:11px; opacity:0.9; font-weight:600}
      .fc-timeGridDay-view .fc-timegrid-col-events{margin:0 4px}
    }
    @media (max-width: 480px){
      header { padding: 8px 10px; }
      header h1 { font-size: 14px; }
      .seg button { padding: 5px 7px; font-size: 10px; }
      .fc .fc-toolbar{gap:4px}
      .fc .fc-toolbar-title{font-size:13px}
      .fc .fc-button{padding:4px 7px; font-size:10px}
      .fc .fc-daygrid-event{padding:2px 4px; min-height:auto; margin:1px 0}
      .fc .fc-daygrid-event .evt{gap:0; align-items:flex-start; text-align:left}
      .fc .fc-daygrid-event .t{font-size:9px; font-weight:700; line-height:1.25; letter-spacing:-0.01em}
      .fc .fc-daygrid-event .tm{display:none}
      .fc .fc-daygrid-day-number{font-size:10px; padding:2px 3px; font-weight:700}
      .fc .fc-col-header-cell{padding:3px 1px; font-size:9px; font-weight:700}
      .fc .fc-daygrid-day-frame{min-height:45px !important}
      .fc .fc-daygrid-day-top{padding:1px}
      
      /* Bardzo kompaktowy widok tygodniowy */
      .fc .fc-timegrid-axis{font-size:7px; padding:0 1px; width:26px}
      .fc .fc-timegrid-slot{height:14px}
      .fc .fc-timegrid-slot-label{font-size:6px; padding:0 1px; line-height:1}
      .fc .fc-timegrid-event{padding:1px 2px; margin:0 0.5px; border-width:0.5px}
      .fc .fc-timegrid-event .fc-event-main{padding:0 1px}
      .fc .fc-timegrid-event .evt{gap:0; align-items:flex-start; text-align:left}
      .fc .fc-timegrid-event .t{font-size:8px; line-height:1.1; font-weight:700; letter-spacing:-0.02em; word-break:break-word; white-space:normal}
      .fc .fc-timegrid-event .tm{font-size:6px; opacity:0.75; font-weight:600}
      .fc .fc-timegrid-col-events{margin:0 0.5px}
      .fc .fc-timegrid-divider{height:0px; display:none}
      .fc .fc-col-header-cell-cushion{padding:2px 0; font-size:7px}
      
      /* Ładniejszy widok dzienny na bardzo małych ekranach */
      .fc-timeGridDay-view .fc-timegrid-axis{font-size:9px; padding:0 3px; width:38px}
      .fc-timeGridDay-view .fc-timegrid-slot{height:30px}
      .fc-timeGridDay-view .fc-timegrid-slot-label{font-size:9px; padding:1px; line-height:1.1}
      .fc-timeGridDay-view .fc-timegrid-event{padding:3px 6px; margin:0 2px; border-width:1px; border-radius:6px}
      .fc-timeGridDay-view .fc-timegrid-event .fc-event-main{padding:3px 6px}
      .fc-timeGridDay-view .fc-timegrid-event .evt{gap:1px; align-items:center; text-align:center; justify-content:center}
      .fc-timeGridDay-view .fc-timegrid-event .t{font-size:11px; line-height:1.25; font-weight:700; word-break:break-word; white-space:normal}
      .fc-timeGridDay-view .fc-timegrid-event .tm{font-size:9px; opacity:0.85; font-weight:600}
      .fc-timeGridDay-view .fc-timegrid-col-events{margin:0 3px}
      .fc-timeGridDay-view .fc-col-header-cell-cushion{padding:6px 2px; font-size:11px; font-weight:700}
      
      main{padding-top:calc(var(--header-h) + 8px)}
    }

    /* Tooltip */
    .tooltip{position:fixed; z-index:9999; background:#0f142b; border:1px solid #2a386b; color:var(--text); padding:10px 12px; border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,.35); max-width:min(320px, calc(100vw - 20px)); pointer-events:none; transition: opacity 0.15s; }
    .tt-title{font-weight:700; margin-bottom:6px}
    .tt-row{display:flex; gap:8px; font-size:12px; color:#c7cfe6; padding:2px 0}
    .tt-row span{color:var(--muted); min-width:90px; flex-shrink: 0;}
    .tt-badge{margin-top:6px; display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid #3a466f}
    .tt-remote{background:rgba(255,65,65,0.12); color:var(--event-remote); border-color:rgba(255,65,65,0.5)}

    /* Eksport do Google Kalendarza */
    .export{ margin-top:16px }
    .gcal-btn{ display:flex; align-items:center; gap:10px; width:100%; padding:12px 14px; border-radius:12px; border:1px solid #2a335a; background:#1a223f; color:#fff; font-weight:700; cursor:pointer; transition: background .2s, border-color .2s, transform .05s; }
    .gcal-btn:hover{ background:#22305d; border-color:#3a4a7a }
    .gcal-btn:active{ transform: translateY(1px) }
    .gcal-logo{ display:inline-flex; width:18px; height:18px }
    .export-hint{ margin-top:8px; color:var(--muted); font-size:12px }

    /* Kafelek: następne/trwające zajęcia */
    .next-card{ 
      background:linear-gradient(180deg,#0d1430 0%, #0b1026 100%); 
      border:1px solid var(--border); 
      border-radius:12px; 
      padding:12px;
      margin-bottom: 16px;
      margin-top: 0;
    }
    .next-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px }
    .next-status{ font-size:12px; color:var(--muted) }
    .next-badge{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #2a335a; background:#0e1430; color:#c9d2ff }
    .next-badge.remote{ color:#ffb3b3; border-color:rgba(255,65,65,0.5); background:rgba(255,65,65,0.08) }
    .next-title{ font-weight:700; font-size:16px; line-height:1.3; color:var(--text); margin:4px 0 }
    .next-time{ font-size:13px; color:#c9d2ff }
    .next-room{ color:var(--muted) }
    .progress{ height:8px; border-radius:999px; background:#142048; border:1px solid #223057; overflow:hidden; margin-top:10px }
    .progress .bar{ height:100%; width:0%; background:linear-gradient(90deg, var(--accent), #4a6bff); transition:width .3s ease }
    .next-card.remote .progress .bar{ background:linear-gradient(90deg, #ff5a5a, #ff7a7a) }
    
    /* Przycisk widgetu w powiadomieniu */
    .widget-notif-btn{
      display:flex; align-items:center; justify-content:center; gap:8px; 
      width:100%; margin-top:12px; padding:10px 14px; 
      background:linear-gradient(135deg, #7c9cff 0%, #5a7ee6 100%); 
      color:#fff; border:0; border-radius:10px; 
      font-weight:700; font-size:13px; cursor:pointer; 
      transition: all 0.2s; box-shadow:0 4px 12px rgba(124,156,255,0.3);
    }
    .widget-notif-btn:hover{
      transform:translateY(-2px); 
      box-shadow:0 6px 16px rgba(124,156,255,0.4);
    }
    .widget-notif-btn:active{
      transform:translateY(0);
    }
    .widget-notif-btn svg{
      flex-shrink:0;
    }

    /* Animacja feedbacku przycisku eksportu */
    @keyframes shiver-kf{0%,100%{transform:translateX(0)}20%{transform:translateX(-2px)}40%{transform:translateX(2px)}60%{transform:translateX(-2px)}80%{transform:translateX(2px)}}
    .gcal-btn.shiver{animation: shiver-kf .3s ease}

    /* Niestandardowy popover "+XX więcej" */
    .fc-popover{
      background: linear-gradient(180deg, #0d1430 0%, #0b1026 100%) !important;
      border: 1px solid var(--border) !important;
      border-radius: 12px !important;
      box-shadow: 0 8px 30px rgba(0,0,0,0.5) !important;
      overflow: hidden !important;
      z-index: 9998 !important;
      animation: popoverFadeIn 0.2s ease;
    }
    @keyframes popoverFadeIn{
      from{ opacity: 0; transform: translateY(-4px); }
      to{ opacity: 1; transform: translateY(0); }
    }
    .fc-popover-header{
      background: linear-gradient(180deg, #1a2447 0%, #0f1a3d 100%) !important;
      border-bottom: 1px solid var(--border) !important;
      padding: 10px 14px !important;
      font-weight: 700 !important;
      font-size: 13px !important;
      color: var(--text) !important;
    }
    .fc-popover-title{
      color: var(--text) !important;
      font-size: 13px !important;
      font-weight: 700 !important;
    }
    .fc-popover-close{
      color: var(--muted) !important;
      opacity: 0.7 !important;
      font-size: 18px !important;
      line-height: 1 !important;
      transition: opacity 0.2s, color 0.2s !important;
    }
    .fc-popover-close:hover{
      opacity: 1 !important;
      color: var(--accent) !important;
    }
    .fc-popover-body{
      padding: 8px !important;
      max-height: 400px !important;
      overflow-y: auto !important;
      background: transparent !important;
    }
    
    /* Wydarzenia w popoverze - ulepszone */
    .fc-popover .fc-daygrid-event{
      margin: 4px 0 !important;
      padding: 8px 10px !important;
      border-radius: 8px !important;
      border: 1px solid rgba(124,156,255,0.3) !important;
      background: linear-gradient(135deg, rgba(32,48,87,0.9) 0%, rgba(20,35,70,0.9) 100%) !important;
      transition: all 0.2s !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
      cursor: pointer !important;
    }
    .fc-popover .fc-daygrid-event:hover{
      transform: translateX(4px) !important;
      box-shadow: 0 4px 12px rgba(124,156,255,0.3) !important;
      border-color: rgba(124,156,255,0.6) !important;
    }
    .fc-popover .fc-daygrid-event.remote{
      background: linear-gradient(135deg, rgba(255,65,65,0.25) 0%, rgba(200,40,40,0.25) 100%) !important;
      border-color: rgba(255,65,65,0.4) !important;
    }
    .fc-popover .fc-daygrid-event.remote:hover{
      border-color: rgba(255,65,65,0.7) !important;
      box-shadow: 0 4px 12px rgba(255,65,65,0.3) !important;
    }
    
    /* Tytuł i czas w popoverze */
    .fc-popover .fc-event-title{
      font-weight: 700 !important;
      font-size: 13px !important;
      color: #e8ecf1 !important;
      line-height: 1.4 !important;
      margin-bottom: 4px !important;
    }
    .fc-popover .fc-event-time{
      font-size: 11px !important;
      color: #b8c5ff !important;
      font-weight: 600 !important;
      opacity: 0.9 !important;
    }
    
    /* Scrollbar dla popovera */
    .fc-popover-body::-webkit-scrollbar{
      width: 6px;
    }
    .fc-popover-body::-webkit-scrollbar-track{
      background: rgba(15,21,43,0.3);
      border-radius: 3px;
    }
    .fc-popover-body::-webkit-scrollbar-thumb{
      background: rgba(124,156,255,0.3);
      border-radius: 3px;
    }
    .fc-popover-body::-webkit-scrollbar-thumb:hover{
      background: rgba(124,156,255,0.5);
    }
    
    /* Responsywność popovera */
    @media (max-width: 900px){
      .fc-popover{
        max-width: min(360px, calc(100vw - 20px)) !important;
      }
      .fc-popover-body{
        max-height: 300px !important;
      }
    }
    @media (max-width: 480px){
      .fc-popover{
        max-width: min(300px, calc(100vw - 16px)) !important;
      }
      .fc-popover-header{
        padding: 8px 10px !important;
        font-size: 12px !important;
      }
      .fc-popover-body{
        max-height: 250px !important;
        padding: 6px !important;
      }
      .fc-popover .fc-daygrid-event{
        padding: 6px 8px !important;
        margin: 3px 0 !important;
      }
      .fc-popover .fc-event-title{
        font-size: 12px !important;
      }
      .fc-popover .fc-event-time{
        font-size: 10px !important;
      }
    }

    /* Mapa kampusu */
    .campus-map{
      margin-top: 16px;
      margin-bottom: 16px;
      background: linear-gradient(180deg, #0d1430 0%, #0b1026 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    .campus-map-title{
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin: 0 0 10px 0;
    }
    .map-container{
      position: relative;
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      background: #f5f5f5;
    }
    .map-svg{
      width: 100%;
      height: auto;
      display: block;
    }
    .map-bg{
      width: 100%;
      height: 100%;
    }
    .building-area{
      fill: transparent;
      stroke: transparent;
      stroke-width: 2;
      transition: all 0.3s ease;
    }
    .building-area:hover{
      fill: rgba(124, 156, 255, 0.3);
      stroke: rgba(124, 156, 255, 0.8);
      stroke-width: 3;
    }
    .building-label{
      position: absolute;
      background: rgba(15, 21, 43, 0.95);
      border: 1px solid var(--accent);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translate(-50%, -100%);
      margin-top: -8px;
    }
    .building-label::after{
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: var(--accent);
    }
    .building-label.visible{
      opacity: 1;
    }
    
    @media (max-width: 900px){
      .campus-map{
        max-width: 600px;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
    }

    /* Przycisk pomocy */
    .help-btn{
      background: linear-gradient(180deg, #1a2447 0%, #0f1a3d 100%);
      border: 1px solid #2a335a;
      color: var(--text);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
    }
    .help-btn:hover{
      background: linear-gradient(180deg, #22305d 0%, #162244 100%);
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    .help-btn svg{
      display: block;
    }

    /* Modal */
    .modal-overlay{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(4px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }
    .modal-overlay.active{
      display: flex;
    }
    @keyframes fadeIn{
      from{ opacity: 0; }
      to{ opacity: 1; }
    }
    .modal{
      background: linear-gradient(180deg, #0d1430 0%, #0b1026 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      max-width: 700px;
      width: 100%;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    @keyframes slideUp{
      from{ opacity: 0; transform: translateY(20px); }
      to{ opacity: 1; transform: translateY(0); }
    }
    .modal-header{
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(180deg, #1a2447 0%, #0f1a3d 100%);
    }
    .modal-title{
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .modal-close{
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      opacity: 0.7;
      transition: all 0.2s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }
    .modal-close:hover{
      opacity: 1;
      background: rgba(255, 255, 255, 0.05);
      color: var(--accent);
    }
    .modal-body{
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-body::-webkit-scrollbar{
      width: 8px;
    }
    .modal-body::-webkit-scrollbar-track{
      background: rgba(15,21,43,0.3);
      border-radius: 4px;
    }
    .modal-body::-webkit-scrollbar-thumb{
      background: rgba(124,156,255,0.3);
      border-radius: 4px;
    }
    .modal-body::-webkit-scrollbar-thumb:hover{
      background: rgba(124,156,255,0.5);
    }

    /* Lista harmonogramów */
    .schedule-list{
      display: grid;
      gap: 12px;
      margin-bottom: 20px;
    }
    .schedule-item{
      background: #0c1330;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }
    .schedule-item:hover{
      border-color: var(--accent);
      transform: translateX(2px);
    }
    .schedule-item.active{
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(124,156,255,0.08) 0%, rgba(124,156,255,0.02) 100%);
    }
    .schedule-item.active::before{
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--accent);
    }
    .schedule-header{
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    .schedule-name{
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      margin: 0 0 4px 0;
    }
    .schedule-path{
      font-size: 12px;
      color: var(--muted);
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }
    .schedule-status{
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    .schedule-status.success{
      background: rgba(52, 211, 153, 0.15);
      color: #34d399;
      border: 1px solid rgba(52, 211, 153, 0.3);
    }
    .schedule-status.error{
      background: rgba(255, 90, 90, 0.15);
      color: var(--danger);
      border: 1px solid rgba(255, 90, 90, 0.3);
    }
    .schedule-status.warning{
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .status-dot{
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    .schedule-meta{
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .schedule-meta-item{
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .schedule-meta-item strong{
      color: var(--text);
      font-weight: 600;
    }
    .schedule-actions{
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .schedule-btn{
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .schedule-btn.primary{
      background: var(--accent);
      color: #0a0f21;
      border-color: var(--accent);
    }
    .schedule-btn.primary:hover{
      background: #5a7ee6;
      transform: translateY(-1px);
    }
    .schedule-btn.secondary{
      background: transparent;
      color: var(--text);
      border-color: var(--border);
    }
    .schedule-btn.secondary:hover{
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent);
    }
    .schedule-btn.danger{
      background: transparent;
      color: var(--danger);
      border-color: rgba(255, 90, 90, 0.3);
    }
    .schedule-btn.danger:hover{
      background: rgba(255, 90, 90, 0.1);
    }

    /* Przycisk dodawania */
    .add-schedule-section{
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 20px;
    }
    .add-schedule-title{
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 12px 0;
    }

    /* Sekcja O aplikacji */
    .about-section{
      border-top: 1px solid var(--border);
      padding-top: 20px;
      margin-top: 20px;
    }
    .about-title{
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .about-content{
      background: #0c1330;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
    }
    .about-item{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .about-item:last-of-type{
      border-bottom: none;
    }
    .about-label{
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }
    .about-value{
      font-size: 13px;
      color: var(--text);
      font-weight: 600;
      text-align: right;
    }
    .about-links{
      display: grid;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .about-link{
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: linear-gradient(180deg, #1a2447 0%, #0f1a3d 100%);
      border: 1px solid #2a335a;
      border-radius: 10px;
      color: var(--text);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    .about-link:hover{
      background: linear-gradient(180deg, #22305d 0%, #162244 100%);
      border-color: var(--accent);
      transform: translateX(4px);
    }
    .about-link svg:first-child{
      flex-shrink: 0;
    }
    .about-link span{
      flex: 1;
    }
    .file-input-wrapper{
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .file-input-label{
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 14px 20px;
      background: linear-gradient(180deg, #1a2447 0%, #0f1a3d 100%);
      border: 2px dashed var(--border);
      border-radius: 12px;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-input-label:hover{
      border-color: var(--accent);
      background: linear-gradient(180deg, #22305d 0%, #162244 100%);
      transform: translateY(-1px);
    }
    .file-input{
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .upload-icon{
      width: 20px;
      height: 20px;
    }

    /* Empty state */
    .empty-state{
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-state svg{
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      opacity: 0.5;
    }
    .empty-state h3{
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin: 0 0 8px 0;
    }
    .empty-state p{
      font-size: 14px;
      margin: 0;
    }

    @media (max-width: 700px){
      .modal{
        max-height: 90vh;
      }
      .modal-header{
        padding: 16px 20px;
      }
      .modal-title{
        font-size: 16px;
      }
      .modal-body{
        padding: 16px 20px;
      }
      .schedule-item{
        padding: 12px;
      }
      .schedule-header{
        flex-direction: column;
        align-items: flex-start;
      }
      .schedule-meta{
        flex-direction: column;
        gap: 8px;
      }
      .schedule-actions{
        flex-direction: column;
      }
      .schedule-btn{
        width: 100%;
      }
      .about-item{
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        padding: 12px 0;
      }
      .about-value{
        text-align: left;
      }
      .about-link{
        padding: 10px 12px;
        font-size: 12px;
      }
    }
    @media (max-width: 480px){
      .help-btn{
        width: 32px;
        height: 32px;
      }
      .help-btn svg{
        width: 18px;
        height: 18px;
      }
      header h1{
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Harmonogram</h1>
    <div style="display: flex; align-items: center; gap: 12px;">
      <div class="seg">
        <button id="viewMonth" aria-pressed="true" data-view="dayGridMonth">Miesiąc</button>
        <button id="viewWeek" aria-pressed="false" data-view="timeGridWeek">Tydzień</button>
        <button id="viewDay" aria-pressed="false" data-view="timeGridDay">Dzień</button>
      </div>
      <button id="helpBtn" class="help-btn" title="Zarządzaj harmonogramami" aria-label="Zarządzaj harmonogramami">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
      </button>
    </div>
  </header>

  <main>
    <aside>
      <!-- Kafelek następujących zajęć -->
      <div class="next-card" id="nextCard" aria-live="polite">
        <div class="next-header">
          <div class="next-status" id="nextStatus">Wyszukiwanie najbliższych zajęć…</div>
          <span class="next-badge" id="nextBadge" style="display:none">Zdalnie</span>
        </div>
        <div class="next-title" id="nextTitle">—</div>
        <div class="next-time"><span id="nextRange">—</span> <span class="next-room" id="nextRoom"></span></div>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Postęp zajęć">
          <div class="bar" id="nextProgress"></div>
        </div>
        <button id="widgetNotification" class="widget-notif-btn" title="Przypnij jako powiadomienie">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span>Przypnij widget</span>
        </button>
      </div>

      <div class="section-title">Filtry</div>
      <div class="filters">
        <div class="group">
          <label for="program">Kierunek studiów</label>
          <select id="program"><option value="">Wszystkie</option></select>
        </div>
        <div class="group">
          <label for="type">Rodzaj zajęć</label>
          <select id="type"><option value="">Wszystkie</option></select>
        </div>
        <div class="group">
          <label for="room">Sala</label>
          <select id="room"><option value="">Wszystkie</option></select>
        </div>
        <div class="group">
          <label for="lecturer">Wykładowca</label>
          <select id="lecturer"><option value="">Wszyscy</option></select>
        </div>
        <button id="reset" class="reset">Wyczyść filtry</button>
      </div>

      <!-- Mapa kampusu -->
      <div class="campus-map">
        <div class="campus-map-title">Mapa Kampusu</div>
        <div class="map-container">
          <svg class="map-svg" viewBox="0 0 896 1152" xmlns="http://www.w3.org/2000/svg">
            <!-- Tło - zdjęcie kampusu -->
            <image class="map-bg" href="./campus-map.png" x="0" y="0" width="896" height="1152" preserveAspectRatio="xMidYMid slice"/>
            
            <!-- CsH - Collegium sub Horologio (górny budynek w kształcie T) -->
            <polygon 
              class="building-area" 
              data-building="csh" 
              data-name="Collegium sub Horologio"
              points="471,154 372,186 342,118 346,89 270,108 314,205 215,245 235,306 453,215 490,216">
              <title>Collegium sub Horologio (CsH)</title>
            </polygon>
            
            <!-- CP - Collegium Primum (środkowy budynek) -->
            <polygon 
              class="building-area" 
              data-building="cp" 
              data-name="Collegium Primum"
              points="559,457 458,491 447,485 430,502 337,537 353,589 573,512">
              <title>Collegium Primum (CP)</title>
            </polygon>
            
            <!-- CI - Collegium Inventorum (dolny budynek) -->
            <polygon 
              class="building-area" 
              data-building="ci" 
              data-name="Collegium Inventorum"
              points="617,648 552,673 611,833 574,858 584,882 626,875 684,1031 749,1003">
              <title>Collegium Inventorum (CI)</title>
            </polygon>
          </svg>
          
          <!-- Etykiety budynków (tooltips) -->
          <div class="building-label" id="label-csh">Collegium sub Horologio (CsH)</div>
          <div class="building-label" id="label-cp">Collegium Primum (CP)</div>
          <div class="building-label" id="label-ci">Collegium Inventorum (CI)</div>
        </div>
      </div>

      <div class="stats">
        <div class="card"><h3>Łącznie</h3><div class="value" id="statTotal">0</div></div>
        <div class="card"><h3>Widocznych</h3><div class="value" id="statVisible">0</div></div>
      </div>

      <div class="export">
        <button id="exportGoogle" class="gcal-btn" aria-label="Eksportuj do Google Kalendarza" title="Pobierz plik .ics z aktualnie przefiltrowanymi wydarzeniami">
          <span class="gcal-logo" aria-hidden="true">
            <!-- Prosty, własny znak w kolorach Google -->
            <svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
              <path fill="#EA4335" d="M24 9.5c3.38 0 6.44 1.18 8.85 3.13l6.63-6.63C35.6 2.25 30.12 0 24 0 14.6 0 6.45 5.4 2.55 13.2l7.92 6.15C12.16 13.5 17.61 9.5 24 9.5z"/>
              <path fill="#4285F4" d="M46.5 24.5c0-1.55-.15-3.05-.44-4.5H24v9h12.7c-.55 2.95-2.19 5.45-4.66 7.13l7.15 5.57C43.93 37.5 46.5 31.42 46.5 24.5z"/>
              <path fill="#FBBC05" d="M10.47 19.35l-7.92-6.15C.9 16.16 0 20.01 0 24c0 3.9.86 7.61 2.4 10.9l8.07-6.22C9.7 26.9 9.3 25.49 9.3 24c0-1.63.43-3.16 1.17-4.65z"/>
              <path fill="#34A853" d="M24 48c6.06 0 11.16-2 14.9-5.4l-7.15-5.57c-2.04 1.38-4.66 2.2-7.75 2.2-6.4 0-11.86-4.03-13.87-9.61l-8.07 6.22C6.88 43.07 14.7 48 24 48z"/>
            </svg>
          </span>
          <span>Importuj do Google Kalendarza</span>
        </button>
        <div class="export-hint">Pobierze plik .ics z obecnie przefiltrowanymi wydarzeniami. Następnie zaimportuj go w Google Kalendarzu.</div>
      </div>
    </aside>
    <section id="calendar"></section>
  </main>

  <div id="tooltip" class="tooltip" style="display:none; opacity: 0;"></div>

  <!-- Modal zarządzania harmonogramami -->
  <div id="scheduleModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          Zarządzaj harmonogramami
        </h2>
        <button class="modal-close" id="modalClose" aria-label="Zamknij">&times;</button>
      </div>
      <div class="modal-body">
        <div id="scheduleListContainer"></div>
        
        <div class="add-schedule-section">
          <h3 class="add-schedule-title">Dodaj nowy harmonogram</h3>
          <div class="file-input-wrapper">
            <label for="fileInput" class="file-input-label">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <span>Wybierz plik JSON</span>
            </label>
            <input type="file" id="fileInput" class="file-input" accept=".json" />
          </div>
        </div>

        <!-- O aplikacji -->
        <div class="about-section">
          <h3 class="about-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            O aplikacji
          </h3>
          <div class="about-content">
            <div class="about-item">
              <div class="about-label">Wersja</div>
              <div class="about-value">1.0.0</div>
            </div>
            <div class="about-item">
              <div class="about-label">Autor</div>
              <div class="about-value">koloksk</div>
            </div>
            <div class="about-item">
              <div class="about-label">Technologie</div>
              <div class="about-value">HTML • CSS • JavaScript • FullCalendar</div>
            </div>
            <div class="about-links">
              <a href="https://github.com/koloksk/harmonogram" target="_blank" rel="noopener noreferrer" class="about-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                <span>Kod źródłowy</span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </a>
              <a href="https://github.com/koloksk/harmonogram/issues" target="_blank" rel="noopener noreferrer" class="about-link">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="8" x2="12" y2="12"></line>
                  <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                <span>Zgłoś problem</span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.15/locales-all.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.15/index.global.min.js"></script>
  <script>
    // ZMIANA: Przeniesienie elementów DOM na górę dla lepszej organizacji
    const calendarEl = document.getElementById('calendar');
    const filterElements = {
      program: document.getElementById('program'),
      type: document.getElementById('type'),
      room: document.getElementById('room'),
      lecturer: document.getElementById('lecturer'),
    };
    const statElements = {
      total: document.getElementById('statTotal'),
      visible: document.getElementById('statVisible'),
    };
    const viewButtons = document.querySelectorAll('.seg button');
    const tooltip = document.getElementById('tooltip');
    
    const STORAGE_KEY = 'harm_filters_v1';
    const SCHEDULES_STORAGE_KEY = 'harm_schedules_v1';
    const ACTIVE_SCHEDULE_KEY = 'harm_active_schedule_v1';
    
    let rawData = { events: [] };
    let fc;
    let schedules = [];
    let activeScheduleId = null;

    // ===== SYSTEM ZARZĄDZANIA HARMONOGRAMAMI =====
    
    function loadSchedulesFromStorage(){
      try{
        const stored = localStorage.getItem(SCHEDULES_STORAGE_KEY);
        schedules = stored ? JSON.parse(stored) : [];
        activeScheduleId = localStorage.getItem(ACTIVE_SCHEDULE_KEY) || null;
        
        // Dodaj domyślny harmonogram jeśli nie ma żadnych
        if(schedules.length === 0){
          schedules.push({
            id: 'default',
            name: 'Harmonogram główny',
            path: './harmonogram.json',
            isDefault: true,
            addedAt: new Date().toISOString(),
            status: 'unknown',
            eventsCount: 0,
            errors: []
          });
          activeScheduleId = 'default';
          saveSchedulesToStorage();
        }
      }catch(e){
        console.error('Błąd wczytywania harmonogramów', e);
        schedules = [];
      }
    }

    function saveSchedulesToStorage(){
      try{
        localStorage.setItem(SCHEDULES_STORAGE_KEY, JSON.stringify(schedules));
        if(activeScheduleId){
          localStorage.setItem(ACTIVE_SCHEDULE_KEY, activeScheduleId);
        }
      }catch(e){
        console.error('Błąd zapisywania harmonogramów', e);
      }
    }

    function getActiveSchedule(){
      return schedules.find(s => s.id === activeScheduleId) || schedules[0];
    }

    async function validateScheduleFile(data, scheduleName){
      const errors = [];
      const warnings = [];
      
      if(!data || typeof data !== 'object'){
        errors.push('Nieprawidłowy format pliku JSON');
        return { valid: false, errors, warnings, eventsCount: 0 };
      }
      
      if(!Array.isArray(data.events)){
        errors.push('Brak tablicy "events" w pliku');
        return { valid: false, errors, warnings, eventsCount: 0 };
      }
      
      const eventsCount = data.events.length;
      
      if(eventsCount === 0){
        warnings.push('Plik nie zawiera żadnych wydarzeń');
      }
      
      // Walidacja struktury wydarzeń
      let invalidEvents = 0;
      data.events.forEach((e, idx) => {
        if(!e.date && !e.start){
          invalidEvents++;
        }
      });
      
      if(invalidEvents > 0){
        warnings.push(`${invalidEvents} wydarzeń nie ma daty`);
      }
      
      return {
        valid: errors.length === 0,
        errors,
        warnings,
        eventsCount
      };
    }

    async function addScheduleFromFile(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try{
            const data = JSON.parse(e.target.result);
            const validation = await validateScheduleFile(data, file.name);
            
            const newSchedule = {
              id: 'custom_' + Date.now(),
              name: file.name.replace('.json', ''),
              path: null, // Custom file, stored in data
              data: data, // Store data directly
              isDefault: false,
              addedAt: new Date().toISOString(),
              status: validation.valid ? 'success' : (validation.errors.length > 0 ? 'error' : 'warning'),
              eventsCount: validation.eventsCount,
              errors: validation.errors,
              warnings: validation.warnings || []
            };
            
            schedules.push(newSchedule);
            saveSchedulesToStorage();
            renderScheduleList();
            resolve(newSchedule);
          }catch(err){
            reject(new Error('Nieprawidłowy format pliku JSON: ' + err.message));
          }
        };
        reader.onerror = () => reject(new Error('Błąd wczytywania pliku'));
        reader.readAsText(file);
      });
    }

    function deleteSchedule(scheduleId){
      if(schedules.find(s => s.id === scheduleId)?.isDefault){
        alert('Nie można usunąć domyślnego harmonogramu');
        return;
      }
      
      schedules = schedules.filter(s => s.id !== scheduleId);
      
      if(activeScheduleId === scheduleId){
        activeScheduleId = schedules[0]?.id || null;
        loadData(); // Reload with new active schedule
      }
      
      saveSchedulesToStorage();
      renderScheduleList();
    }

    function switchSchedule(scheduleId){
      activeScheduleId = scheduleId;
      saveSchedulesToStorage();
      loadData(); // Reload calendar with new schedule
      renderScheduleList();
    }

    function renderScheduleList(){
      const container = document.getElementById('scheduleListContainer');
      
      if(schedules.length === 0){
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <h3>Brak harmonogramów</h3>
            <p>Dodaj swój pierwszy harmonogram poniżej</p>
          </div>
        `;
        return;
      }
      
      const html = `
        <div class="schedule-list">
          ${schedules.map(schedule => {
            const isActive = schedule.id === activeScheduleId;
            const statusClass = schedule.status === 'success' ? 'success' : 
                               schedule.status === 'error' ? 'error' : 'warning';
            const statusText = schedule.status === 'success' ? 'OK' : 
                              schedule.status === 'error' ? 'Błąd' : 'Ostrzeżenie';
            
            return `
              <div class="schedule-item ${isActive ? 'active' : ''}" data-schedule-id="${schedule.id}">
                <div class="schedule-header">
                  <div>
                    <h3 class="schedule-name">
                      ${escapeHtml(schedule.name)}
                      ${isActive ? ' <span style="color: var(--accent); font-size: 12px;">● Aktywny</span>' : ''}
                    </h3>
                    ${schedule.path ? `<div class="schedule-path">${escapeHtml(schedule.path)}</div>` : '<div class="schedule-path">Plik własny</div>'}
                  </div>
                  <div class="schedule-status ${statusClass}">
                    <span class="status-dot"></span>
                    ${statusText}
                  </div>
                </div>
                
                <div class="schedule-meta">
                  <div class="schedule-meta-item">
                    <span>📊 Wydarzenia:</span>
                    <strong>${schedule.eventsCount}</strong>
                  </div>
                  <div class="schedule-meta-item">
                    <span>📅 Dodano:</span>
                    <strong>${new Date(schedule.addedAt).toLocaleDateString('pl-PL')}</strong>
                  </div>
                  ${schedule.errors && schedule.errors.length > 0 ? `
                    <div class="schedule-meta-item" style="color: var(--danger);">
                      <span>⚠️ Błędy:</span>
                      <strong>${schedule.errors.length}</strong>
                    </div>
                  ` : ''}
                  ${schedule.warnings && schedule.warnings.length > 0 ? `
                    <div class="schedule-meta-item" style="color: #fbbf24;">
                      <span>⚠️ Ostrzeżenia:</span>
                      <strong>${schedule.warnings.length}</strong>
                    </div>
                  ` : ''}
                </div>
                
                ${schedule.errors && schedule.errors.length > 0 ? `
                  <div style="margin-top: 10px; padding: 10px; background: rgba(255,90,90,0.1); border-radius: 8px; font-size: 12px; color: var(--danger);">
                    ${schedule.errors.map(e => `• ${escapeHtml(e)}`).join('<br>')}
                  </div>
                ` : ''}
                
                ${schedule.warnings && schedule.warnings.length > 0 ? `
                  <div style="margin-top: 10px; padding: 10px; background: rgba(251,191,36,0.1); border-radius: 8px; font-size: 12px; color: #fbbf24;">
                    ${schedule.warnings.map(w => `• ${escapeHtml(w)}`).join('<br>')}
                  </div>
                ` : ''}
                
                <div class="schedule-actions">
                  ${!isActive ? `<button class="schedule-btn primary" onclick="switchSchedule('${schedule.id}')">Aktywuj</button>` : ''}
                  ${!schedule.isDefault ? `<button class="schedule-btn danger" onclick="confirmDeleteSchedule('${schedule.id}')">Usuń</button>` : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      container.innerHTML = html;
    }

    function confirmDeleteSchedule(scheduleId){
      const schedule = schedules.find(s => s.id === scheduleId);
      if(confirm(`Czy na pewno chcesz usunąć harmonogram "${schedule.name}"?`)){
        deleteSchedule(scheduleId);
      }
    }

    // Modal controls
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('scheduleModal');
      const helpBtn = document.getElementById('helpBtn');
      const modalClose = document.getElementById('modalClose');
      const fileInput = document.getElementById('fileInput');
      
      helpBtn.addEventListener('click', () => {
        modal.classList.add('active');
        renderScheduleList();
      });
      
      modalClose.addEventListener('click', () => {
        modal.classList.remove('active');
      });
      
      modal.addEventListener('click', (e) => {
        if(e.target === modal){
          modal.classList.remove('active');
        }
      });
      
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        try{
          await addScheduleFromFile(file);
          alert('✅ Harmonogram dodany pomyślnie!');
          fileInput.value = ''; // Reset input
        }catch(err){
          alert('❌ ' + err.message);
        }
      });
    });
    
    // Make functions global
    window.switchSchedule = switchSchedule;
    window.confirmDeleteSchedule = confirmDeleteSchedule;
    
    // ===== KONIEC SYSTEMU ZARZĄDZANIA =====

    // Funkcja do dynamicznego dostosowywania widoku
    function getDayMax(){
      const w = window.innerWidth;
      if(w <= 480) return 4;
      if(w <= 700) return 5;
      if(w <= 900) return 6;
      return 6;
    }

    // ZMIANA: Uproszczona funkcja resize, głównie do ustawiania zmiennej CSS
    function handleResize(){
      const header = document.querySelector('header');
      const headerHeight = header ? header.offsetHeight : 65;
      document.documentElement.style.setProperty('--header-h', `${headerHeight}px`);
      
      if(fc){
        fc.setOption('dayMaxEventRows', getDayMax());
        // fc.updateSize() jest teraz mniej krytyczne, bo wysokość jest 'auto'
      }
    }

    async function loadData() {
      try {
        loadSchedulesFromStorage();
        const activeSchedule = getActiveSchedule();
        
        if(!activeSchedule){
          throw new Error('Brak aktywnego harmonogramu');
        }
        
        // Load from stored data or fetch from path
        if(activeSchedule.data){
          rawData = activeSchedule.data;
        } else {
          const res = await fetch(activeSchedule.path, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          rawData = await res.json();
        }
        
        rawData.events = (rawData.events || []).map(e => normalizeEvent(e));
        
        // Update schedule status
        const validation = await validateScheduleFile(rawData, activeSchedule.name);
        const scheduleIndex = schedules.findIndex(s => s.id === activeSchedule.id);
        if(scheduleIndex !== -1){
          schedules[scheduleIndex].status = validation.valid ? 'success' : (validation.errors.length > 0 ? 'error' : 'warning');
          schedules[scheduleIndex].eventsCount = validation.eventsCount;
          schedules[scheduleIndex].errors = validation.errors;
          schedules[scheduleIndex].warnings = validation.warnings || [];
          saveSchedulesToStorage();
        }
        
        statElements.total.textContent = rawData.events.length;
        initFilters(rawData.events);
        initCalendar(rawData.events);
        applyFilters();
        handleResize();
      } catch (error) {
        console.error("Nie udało się załadować danych:", error);
        calendarEl.innerHTML = `<p style="color: var(--danger); text-align: center; padding: 20px;">Błąd ładowania harmonogramu: ${error.message}<br><br>Kliknij przycisk ? aby zarządzać harmonogramami.</p>`;
      }
    }

    function normalizeEvent(e){
      const out = { ...e };
      if(!out.title && out.raw){ out.title = (String(out.raw).split(/\n|\r/)[0] || '').trim(); }
      if(out.isRemote || out.color === 'red') out.classNames = ['remote'];
      if(out.date && out.startTime){ out.start = out.date + 'T' + out.startTime; }
      if(out.date && out.endTime){ out.end = out.date + 'T' + out.endTime; }
      return out;
    }
    
    function unique(values){ return [...new Set(values.filter(Boolean))].sort(); }

    function initFilters(events){
      const populateSelect = (selectEl, values) => {
        for(const val of unique(values)){
          const o = document.createElement('option'); o.value=o.textContent=val; selectEl.appendChild(o);
        }
      };
      
      populateSelect(filterElements.program, events.map(e => e.program));
      // Automatyczne wykrywanie typu, jeśli nie jest podany
      const typeSet = new Set(events.map(e=>e.type).filter(Boolean));
      if(typeSet.size === 0) {
        events.forEach(e => {
          const t = (e.raw||'').toUpperCase();
          if(t.includes(' LAB')) e.type='LAB';
          else if(t.includes(' PROJEKT')) e.type='PROJEKT';
          else if(/\bW\b/.test(t) || t.includes(' W\n')) e.type='W';
          else if(t.includes(' ĆW') || t.includes(' ?W')) e.type='ĆW';
        });
      }
      populateSelect(filterElements.type, events.map(e => e.type));
      populateSelect(filterElements.room, events.map(e => e.location));
      
      // Wykładowcy - spłaszczenie tablic
      const allLecturers = events.flatMap(e => e.lecturers || []);
      populateSelect(filterElements.lecturer, allLecturers);

      // Ładowanie zapisanych filtrów
      try{
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        for (const key in saved) {
          if (filterElements[key] && saved[key] && [...filterElements[key].options].some(o => o.value === saved[key])) {
            filterElements[key].value = saved[key];
          }
        }
      }catch(e){ console.warn("Nie udało się załadować filtrów z LocalStorage", e); }

      // Event Listeners
      Object.values(filterElements).forEach(el=> el.addEventListener('change', () => {
        saveFilters();
        applyFilters();
      }));
      document.getElementById('reset').addEventListener('click', ()=>{
        Object.values(filterElements).forEach(el => el.value = '');
        saveFilters();
        applyFilters();
      });
      
      // ZMIANA: Uproszczone przełączanie widoków
      viewButtons.forEach(button => {
        button.addEventListener('click', () => switchView(button.dataset.view));
      });
      
      window.addEventListener('resize', handleResize);
      window.addEventListener('orientationchange', handleResize);
    }
    
    function saveFilters(){
      const data = { 
        program: filterElements.program.value, 
        type: filterElements.type.value, 
        room: filterElements.room.value,
        lecturer: filterElements.lecturer.value
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function switchView(viewName){
      if(!fc) return;
      fc.changeView(viewName);
      viewButtons.forEach(button => {
        button.setAttribute('aria-pressed', String(button.dataset.view === viewName));
      });
      // Nie ma potrzeby save/apply/resize tutaj, bo to się dzieje w 'datesSet'
    }

    function initCalendar(events){
      if(fc) fc.destroy();
      const isMobile = window.innerWidth <= 900;
      fc = new FullCalendar.Calendar(calendarEl, {
        locale: 'pl', firstDay: 1, initialView: 'dayGridMonth',
        // ZMIANA: Kluczowa zmiana pozwalająca na naturalny wzrost kalendarza i scroll strony
        height: isMobile ? 'auto' : 'auto',
        contentHeight: isMobile ? 'auto' : undefined,
        events: [],
        displayEventEnd: true,
        dayMaxEventRows: getDayMax(),
        fixedWeekCount: false,
        showNonCurrentDates: true, // Zmienione na true, bo CSS je styluje, a to lepsze dla nawigacji
        moreLinkClick: isMobile ? 'popover' : 'popover',
        dayMaxEvents: isMobile,
        allDaySlot: false,
        handleWindowResize: false, // Kontrolujemy resize ręcznie
        slotDuration: '00:15:00',
        slotLabelInterval: '01:00:00',
        slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        slotMinTime: '08:00:00',
        slotMaxTime: '21:30:00',
        expandRows: true,
        nowIndicator: true,
        eventContent: arg => {
          const e = arg.event.extendedProps;
          const time = (e.startTime && e.endTime) ? `${e.startTime}–${e.endTime}` : '';
          const title = (arg.event.title || '').trim();
          const html = `<div class="evt"><span class="t">${escapeHtml(title)}</span>${time ? `<span class="tm">${time}</span>`:''}</div>`;
          return { html };
        },
        eventDidMount: info => {
          info.el.addEventListener('mouseenter', ()=> showTooltip(info.el, buildTooltipHtml(info.event.extendedProps, info.event.classNames.includes('remote'))));
          info.el.addEventListener('mouseleave', hideTooltip);
        },
        moreLinkContent: arg => {
          return { html: `<span style="font-weight: 700; color: var(--accent);">+${arg.num} więcej</span>` };
        },
        moreLinkDidMount: info => {
          // Dodaj styl hover dla linku "+XX więcej"
          info.el.style.transition = 'all 0.2s';
          info.el.addEventListener('mouseenter', () => {
            info.el.style.transform = 'translateY(-1px)';
            info.el.style.textDecoration = 'none';
          });
          info.el.addEventListener('mouseleave', () => {
            info.el.style.transform = 'translateY(0)';
          });
        },
        datesSet: () => { 
          applyFilters(); 
          handleResize(); 
        },
      });
      fc.render();
    }
    
    function buildTooltipHtml(e, isRemote){
      const rows = [];
      const addRow = (label, value) => {
        if(value) rows.push(`<div class="tt-row"><span>${label}:</span><b>${escapeHtml(value)}</b></div>`);
      };

      if(e.title) rows.push(`<div class="tt-title">${escapeHtml(e.title)}</div>`);
      addRow('Data', e.date);
      addRow('Godziny', e.startTime && e.endTime ? `${e.startTime}–${e.endTime}` : e.startTime);
      addRow('Program', e.program);
      addRow('Typ', e.type);
      addRow('Sala', e.location);
      addRow('Prowadzący', e.lecturers?.join(', '));
      addRow('Zjazd', e.zjazd);
      
      if(isRemote) rows.push(`<div class="tt-badge tt-remote">Zajęcia zdalne</div>`);
      return rows.join('');
    }

    function escapeHtml(str){
      return String(str||'').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
    }

    function showTooltip(el, html){
      if (!html) return;
      tooltip.innerHTML = html;
      tooltip.style.display = 'block';
      requestAnimationFrame(() => {
        tooltip.style.opacity = '1';
        const rect = el.getBoundingClientRect();
        const pad = 8;
        
        let left = rect.left + (rect.width/2) - (tooltip.offsetWidth/2);
        left = Math.max(10, Math.min(left, window.innerWidth - tooltip.offsetWidth - 10));
        
        let top = rect.top - tooltip.offsetHeight - pad;
        if(top < 10){ top = rect.bottom + pad; }
        
        tooltip.style.transform = `translate(${left}px, ${top}px)`;
      });
    }

    function hideTooltip(){ 
      tooltip.style.opacity = '0';
      // Czekamy na koniec animacji zanim ukryjemy element
      setTimeout(() => {
        if (tooltip.style.opacity === '0') {
          tooltip.style.display = 'none';
        }
      }, 150);
    }
    
    // ZMIANA: Ustawienie transform zamiast top/left dla płynniejszej animacji i wydajności
    tooltip.style.top = '0';
    tooltip.style.left = '0';

    let lastFiltered = [];
    let nextTimerId;

    const nextEls = {
      card: null, status: null, badge: null, title: null, range: null, room: null, bar: null
    };

    document.addEventListener('DOMContentLoaded', ()=>{
      nextEls.card = document.getElementById('nextCard');
      nextEls.status = document.getElementById('nextStatus');
      nextEls.badge = document.getElementById('nextBadge');
      nextEls.title = document.getElementById('nextTitle');
      nextEls.range = document.getElementById('nextRange');
      nextEls.room = document.getElementById('nextRoom');
      nextEls.bar = document.getElementById('nextProgress');
    });

    function humanizeMinutes(mins){
      const m = Math.max(0, Math.round(mins));
      const d = Math.floor(m / 1440);
      const h = Math.floor((m % 1440) / 60);
      const mm = m % 60;
      if(d>0 && h>0) return `${d} d ${h} h`;
      if(d>0) return `${d} d`;
      if(h>0 && mm>0) return `${h} h ${mm} min`;
      if(h>0) return `${h} h`;
      return `${mm} min`;
    }

    function fmtHM(d){ return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

    function ensureEndISO(ev){
      if(ev.end) return ev.end;
      // domyślnie +60 min gdy brak końca
      const d = new Date(ev.start);
      d.setMinutes(d.getMinutes()+60);
      return d.toISOString();
    }

    function pickNextOrCurrent(events){
      const now = new Date();
      const enriched = events
        .filter(e=>e.start)
        .map(e=>({
          e,
          start: new Date(e.start),
          end: new Date(ensureEndISO(e))
        }))
        .filter(x=>!isNaN(x.start) && !isNaN(x.end))
        .sort((a,b)=> a.start - b.start);

      const ongoing = enriched.filter(x=> now >= x.start && now < x.end)
                              .sort((a,b)=> a.end - b.end);
      if(ongoing.length) return { kind:'ongoing', ...ongoing[0] };

      const upcoming = enriched.filter(x=> x.start > now);
      if(upcoming.length) return { kind:'upcoming', ...upcoming[0] };

      return null;
    }

    function updateNextTile(){
      if(!nextEls.card) return;
      const pick = pickNextOrCurrent(lastFiltered);
      if(!pick){
        nextEls.card.classList.remove('remote');
        nextEls.status.textContent = 'Brak nadchodzących zajęć';
        nextEls.badge.style.display = 'none';
        nextEls.title.textContent = '—';
        nextEls.range.textContent = '—';
        nextEls.room.textContent = '';
        nextEls.bar.style.width = '0%';
        nextEls.bar.parentElement.setAttribute('aria-valuenow','0');
        return;
      }

      const { e, start, end, kind } = pick;
      const isRemote = (e.classNames||[]).includes('remote');
      nextEls.card.classList.toggle('remote', isRemote);
      nextEls.badge.style.display = isRemote ? '' : 'none';

      // Tytuł, godziny, sala
      nextEls.title.textContent = (e.title||'Zajęcia');
      nextEls.range.textContent = `${fmtHM(start)}–${fmtHM(end)}`;
      nextEls.room.textContent = e.location ? `• ${e.location}` : (isRemote ? '• Zdalnie' : '');

      const totalMin = (end - start)/60000;
      const leftToStart = (start - new Date())/60000;

      if(kind==='ongoing'){
        const elapsed = (new Date() - start)/60000;
        const pct = Math.max(0, Math.min(100, (elapsed/totalMin)*100));
        nextEls.status.textContent = `Trwają · do końca ${humanizeMinutes(totalMin - elapsed)}`;
        nextEls.bar.style.width = pct.toFixed(1)+'%';
        nextEls.bar.parentElement.setAttribute('aria-valuenow', String(Math.round(pct)));
      }else{
        nextEls.status.textContent = `Następne za ${humanizeMinutes(leftToStart)}`;
        nextEls.bar.style.width = '0%';
        nextEls.bar.parentElement.setAttribute('aria-valuenow','0');
      }
    }

    function startNextTimer(){
      clearInterval(nextTimerId);
      nextTimerId = setInterval(updateNextTile, 30000); // odświeżaj co 30s
    }



    function applyFilters(){
      const fProg = filterElements.program.value;
      const fType = filterElements.type.value;
      const fRoom = filterElements.room.value;
      const fLecturer = filterElements.lecturer.value;

      const filtered = rawData.events.filter(ev => {
        if(fProg && ev.program !== fProg) return false;
        if(fType && ev.type !== fType) return false;
        if(fRoom && ev.location !== fRoom) return false;
        if(fLecturer && (!ev.lecturers || !ev.lecturers.includes(fLecturer))) return false;
        return true;
      });

      lastFiltered = filtered; // zapisz aktualnie przefiltrowane wydarzenia

      fc.removeAllEvents();
      fc.addEventSource(filtered.map(e => ({
        title: e.title || (e.raw||'').slice(0,60),
        start: e.start,
        end: e.end,
        classNames: e.classNames,
        extendedProps: e,
      })));

      statElements.visible.textContent = filtered.length;
      updateNextTile();
      startNextTimer();
    }

    // Pomocnicze funkcje dla ICS
    function addMinutesLocalIso(dtStr, minutes){
      const d = new Date(dtStr);
      d.setMinutes(d.getMinutes() + (minutes||0));
      return d.toISOString();
    }

    function icsEscape(str){
      return String(str||'')
        .replace(/\\/g,'\\\\')
        .replace(/\n/g,'\\n')
        .replace(/,/g,'\\,')
        .replace(/;/g,'\\;');
    }

    function simpleHash(s){
      let h = 0; 
      for(let i=0;i<s.length;i++){ 
        h = ((h<<5) - h) + s.charCodeAt(i); 
        h |= 0; 
      }
      return Math.abs(h).toString(36);
    }

    // Pomocnicze: składanie linii ICS do 75 znaków (RFC 5545)
    function foldIcsLine(line){
      const maxLen = 75;
      if(line.length <= maxLen) return line;
      let out = '';
      for(let i=0; i<line.length; i+=maxLen){
        const chunk = line.slice(i, i+maxLen);
        out += (i===0 ? chunk : `\r\n ${chunk}`);
      }
      return out;
    }
    function foldIcs(lines){ return lines.map(foldIcsLine).join('\r\n'); }

    // Format daty w UTC do ICS: YYYYMMDDTHHMMSSZ
    function toIcsUtc(dt){
      const d = (dt instanceof Date) ? dt : new Date(dt);
      const y = d.getUTCFullYear();
      const M = String(d.getUTCMonth()+1).padStart(2,'0');
      const D = String(d.getUTCDate()).padStart(2,'0');
      const h = String(d.getUTCHours()).padStart(2,'0');
      const m = String(d.getUTCMinutes()).padStart(2,'0');
      const s = String(d.getUTCSeconds()).padStart(2,'0');
      return `${y}${M}${D}T${h}${m}${s}Z`;
    }

    function buildICS(events){
      const lines = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//MUP Harmonogram//PL',
        'CALSCALE:GREGORIAN',
        'METHOD:PUBLISH'
      ];
      const stamp = toIcsUtc(new Date());
      events.forEach((e)=>{
        if(!e.start) return; // wymagany DTSTART
        const startUtc = toIcsUtc(e.start);
        const endUtc = toIcsUtc(e.end || addMinutesLocalIso(e.start, 60));
        const title = icsEscape(e.title || 'Zajęcia');
        const lecturers = (e.lecturers && e.lecturers.length) ? `Prowadzący: ${e.lecturers.join(', ')}` : '';
        const parts = [
          e.program ? `Program: ${e.program}` : '',
          e.type ? `Typ: ${e.type}` : '',
          e.location ? `Sala: ${e.location}` : ((e.classNames||[]).includes('remote') ? 'Zdalnie' : ''),
          lecturers,
          e.zjazd ? `Zjazd: ${e.zjazd}` : '',
        ].filter(Boolean);
        const desc = icsEscape(parts.join('\n'));
        const loc = icsEscape(e.location || ((e.classNames||[]).includes('remote') ? 'Zdalnie' : ''));
        const uid = simpleHash(`${e.start}|${e.end}|${e.title||''}|${e.location||''}`) + '@mup';

        lines.push('BEGIN:VEVENT');
        if(stamp) lines.push(`DTSTAMP:${stamp}`);
        lines.push(`UID:${uid}`);
        lines.push(`DTSTART:${startUtc}`);
        if(endUtc) lines.push(`DTEND:${endUtc}`);
        lines.push(`SUMMARY:${title}`);
        if(desc) lines.push(`DESCRIPTION:${desc}`);
        if(loc) lines.push(`LOCATION:${loc}`);
        lines.push('END:VEVENT');
      });
      lines.push('END:VCALENDAR');
      return foldIcs(lines) + '\r\n';
    }

    function exportToGoogleCalendar(){
      const events = lastFiltered || [];
      const btn = document.getElementById('exportGoogle');
      if(!events.length){
        if(btn){ btn.classList.add('shiver'); setTimeout(()=>btn.classList.remove('shiver'), 300); }
        return;
      }
      try{
        const ics = buildICS(events);
        const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'harmonogram_przefiltrowany.ics';
        document.body.appendChild(a);
        a.click();
        a.remove();
        // opóźnij revoke, by uniknąć anulowania pobrania w niektórych przeglądarkach
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      }catch(err){
        console.error('Eksport ICS nie powiódł się', err);
        if(btn){ btn.classList.add('shiver'); setTimeout(()=>btn.classList.remove('shiver'), 600); }
      }
    }

    // Obsługa mapy kampusu
    function initCampusMap(){
      const buildings = document.querySelectorAll('.building-area');
      const mapContainer = document.querySelector('.map-container');
      
      if(!buildings.length || !mapContainer) return;
      
      buildings.forEach(building => {
        const code = building.dataset.building;
        const label = document.getElementById(`label-${code}`);
        
        if(!label) return;
        
        building.addEventListener('mouseenter', (e) => {
          // Pokaż tooltip
          label.classList.add('visible');
          
          // Pozycjonuj tooltip
          const rect = building.getBoundingClientRect();
          const containerRect = mapContainer.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2 - containerRect.left;
          const centerY = rect.top - containerRect.top;
          
          label.style.left = centerX + 'px';
          label.style.top = centerY + 'px';
        });
        
        building.addEventListener('mouseleave', () => {
          label.classList.remove('visible');
        });
      });
    }

    // Podpięcie przycisku eksportu
    document.addEventListener('DOMContentLoaded', ()=>{
      const exportBtn = document.getElementById('exportGoogle');
      if(exportBtn){ exportBtn.addEventListener('click', exportToGoogleCalendar); }
      
      // Inicjalizacja mapy kampusu
      initCampusMap();
      
      // Obsługa przycisku powiadomienia widgetu
      const widgetNotifBtn = document.getElementById('widgetNotification');
      if(widgetNotifBtn){ 
        widgetNotifBtn.addEventListener('click', showWidgetNotification); 
      }
    });

    // Funkcja pokazująca widget jako powiadomienie
    async function showWidgetNotification() {
      try {
        // Sprawdź czy przeglądarka obsługuje powiadomienia
        if (!('Notification' in window)) {
          alert('Twoja przeglądarka nie obsługuje powiadomień');
          return;
        }

        // Poproś o uprawnienia do powiadomień
        let permission = Notification.permission;
        if (permission === 'default') {
          permission = await Notification.requestPermission();
        }

        if (permission !== 'granted') {
          alert('Musisz zezwolić na wyświetlanie powiadomień, aby używać widgetu');
          return;
        }

        // Sprawdź czy Service Worker w ogóle istnieje
        if (!('serviceWorker' in navigator)) {
          alert('Service Worker nie jest wspierany w tej przeglądarce');
          return;
        }

        console.log('🔍 Czekam na Service Worker (max 10s)...');
        
        // Poczekaj na Service Worker z timeout
        let registration;
        try {
          registration = await Promise.race([
            navigator.serviceWorker.ready,
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Timeout')), 10000)
            )
          ]);
          console.log('✅ Service Worker gotowy!');
        } catch (timeoutError) {
          console.error('❌ Service Worker nie aktywował się w ciągu 10s');
          alert('Service Worker ładuje się zbyt wolno. Odśwież stronę i spróbuj ponownie.');
          return;
        }
        
        console.log('📋 Stan SW:', {
          installing: !!registration.installing,
          waiting: !!registration.waiting,
          active: !!registration.active,
          scope: registration.scope
        });

        // Sprawdź czy jest aktywny
        if (!registration.active) {
          console.error('❌ Brak aktywnego Service Workera!');
          alert('Service Worker nie jest aktywny. Odśwież stronę.');
          return;
        }

        console.log('📤 Wysyłam polecenie "showWidget" do Service Workera...');
        registration.active.postMessage({ action: 'showWidget' });
        console.log('✅ Polecenie wysłane!');
        
        showSuccessFeedback();

      } catch (error) {
        console.error('Błąd podczas wysyłania polecenia do Service Workera:', error);
        alert('Wystąpił krytyczny błąd przy próbie pokazania powiadomienia: ' + error.message);
      }
    }

    // Funkcja do pokazywania feedbacku po kliknięciu
    function showSuccessFeedback() {
      const btn = document.getElementById('widgetNotification');
      if (!btn) return;
      
      const originalText = btn.innerHTML;
      btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Przypięto!</span>';
      btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
      
      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
      }, 2000);
    }

    // Funkcja znajdujaca następne zajęcia
    function getNextClass(data) {
      const now = new Date();
      
      // Jeśli dane mają strukturę z events
      if (!data.events || !Array.isArray(data.events)) {
        console.error('Brak danych o zajęciach');
        return null;
      }

      let foundClass = null;
      let minDiff = Infinity;

      for (const event of data.events) {
        // Parsuj datę i czas wydarzenia
        const eventDate = new Date(event.date);
        const [hours, minutes] = event.startTime.split(':').map(Number);
        eventDate.setHours(hours, minutes, 0, 0);
        
        // Oblicz różnicę czasu
        const diff = eventDate - now;
        
        // Pomiń przeszłe zajęcia
        if (diff < 0) continue;
        
        // Znajdź najbliższe zajęcia
        if (diff < minDiff) {
          minDiff = diff;
          foundClass = {
            title: event.title,
            start: event.startTime,
            end: event.endTime,
            location: event.location,
            teacher: event.lecturers && event.lecturers.length > 0 ? event.lecturers.join(', ') : '',
            date: event.date,
            startDateTime: eventDate
          };
        }
      }

      return foundClass;
    }

    // Funkcja obliczająca czas do zajęć
    function getTimeUntilClass(classInfo) {
      if (!classInfo || !classInfo.startDateTime) return '';
      
      const now = new Date();
      const diff = classInfo.startDateTime - now;
      const diffMinutes = Math.floor(diff / (1000 * 60));
      const diffHours = Math.floor(diffMinutes / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffDays > 0) {
        return `Za ${diffDays} ${diffDays === 1 ? 'dzień' : 'dni'}`;
      } else if (diffHours > 0) {
        const remainingMinutes = diffMinutes % 60;
        if (remainingMinutes > 0) {
          return `Za ${diffHours}h ${remainingMinutes}min`;
        }
        return `Za ${diffHours}h`;
      } else if (diffMinutes > 0) {
        return `Za ${diffMinutes} min`;
      } else {
        return 'Teraz';
      }
    }

    // Widget support - aktualizacja danych dla widgetu
    async function updateWidgetData() {
      try {
        const pick = pickNextOrCurrent(lastFiltered || rawData.events);
        const widgetData = {
          lastUpdate: new Date().toISOString(),
          events: lastFiltered || rawData.events
        };
        
        localStorage.setItem('harm_widget_cache', JSON.stringify({ events: widgetData.events }));
        
        // Register periodic background sync if supported
        if ('serviceWorker' in navigator && 'periodicSync' in ServiceWorkerRegistration.prototype) {
          try {
            const registration = await navigator.serviceWorker.ready;
            await registration.periodicSync.register('update-widget', {
              minInterval: 5 * 60 * 1000 // 5 minutes
            });
          } catch (e) {
            console.warn('Periodic sync registration failed', e);
          }
        }
      } catch (error) {
        console.error('Widget data update failed:', error);
      }
    }

    // Update widget data when filters change
    const originalApplyFilters = applyFilters;
    applyFilters = function() {
      originalApplyFilters();
      updateWidgetData();
    };

    // Initial widget data update
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        updateWidgetData();
        setInterval(updateWidgetData, 5 * 60 * 1000); // Update every 5 minutes
      }, 1000);
    });
    loadData();
  </script>
</body>
</html>